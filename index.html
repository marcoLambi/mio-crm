<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CRM WorkReport</title>
    
    <!-- 1. Stile Grafico (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Motore dell'App (React) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Traduttore Codice (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Libreria per Export Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Sfondo body leggermente più scuro */
        body { font-family: 'Segoe UI', sans-serif; background-color: #e5e7eb; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .h-dvh { height: 100dvh; }
        input, textarea, select { font-size: 16px !important; } 

        .wheel-scroller {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .wheel-scroller::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURAZIONE
        const appId = "miocrm-0001";
        const firebaseConfig = {
            apiKey: "AIzaSyAjP1UXwDJqAhWVjpb6ePrgtv3nQJ7fWFk",
            authDomain: "miocrm-0001.firebaseapp.com",
            projectId: "miocrm-0001",
            storageBucket: "miocrm-0001.firebasestorage.app",
            messagingSenderId: "880667208118",
            appId: "1:880667208118:web:d1d420b2d7d1743fde7917"
        };

        const { useState, useEffect, useMemo, useRef, useContext, createContext, useCallback } = React;

        const CRMContext = createContext();

        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        
        const Icons = {
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            LayoutDashboard: (p) => <IconBase {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Lightbulb: (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5a6 6 0 0 0-11 0c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Mail: (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>,
            Phone: (p) => <IconBase {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            Building2: (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>,
            MessageSquare: (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            Bell: (p) => <IconBase {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconBase>,
            AlarmCheck: (p) => <IconBase {...p}><circle cx="12" cy="13" r="8"/><path d="M5 3 2 6"/><path d="m22 6-3-3"/><path d="M6.38 18.7 4 21"/><path d="M17.64 18.67 20 21"/><path d="m9 13 2 2 4-4"/></IconBase>,
            Loader2: (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            Check: (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>,
            ArrowUpDown: (p) => <IconBase {...p}><path d="m21 16-4 4-4-4"/><path d="m17 20V4"/><path d="m3 8 4-4 4 4"/><path d="m7 4v16"/></IconBase>,
            ClipboardList: (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>,
            BarChart: (p) => <IconBase {...p}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></IconBase>,
            CheckSquare: (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h11"/></IconBase>,
            BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>
        };

        const InfoBox = ({ label, value, icon: Icon, color = 'text-gray-700' }) => (
            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 shadow-sm">
                <div className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1 mb-1">{Icon && <Icon size={12} className={color} />} {label}</div>
                <div className={`text-lg font-semibold ${color}`}>{value || '-'}</div>
            </div>
        );

        const InfoRow = ({ label, value }) => (
            <div className="flex justify-between border-b border-gray-50 pb-2 last:border-0">
                <span className="text-sm text-gray-500">{label}:</span>
                <span className="text-sm font-semibold text-gray-800 text-right max-w-[60%] truncate">{value || '-'}</span>
            </div>
        );

        const Input = ({ label, name, value, onChange, type = 'text', required = false, step = null, placeholder = '' }) => (
            <div>
                {label && <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>}
                <input type={type} name={name} value={value ?? ''} onChange={onChange} required={required} step={step} placeholder={placeholder} 
                    className="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" />
            </div>
        );

        const TextArea = ({ label, name, value, onChange, placeholder = '' }) => (
            <div>
                <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>
                <textarea name={name} value={value ?? ''} onChange={onChange} placeholder={placeholder} rows="3" 
                    className="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none transition-shadow" />
            </div>
        );
        
        const SelectComponent = ({ label, name, value, onChange, options }) => (
            <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">{label}</label>
                <select name={name} value={value ?? ''} onChange={onChange} className="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                    {options.map(option => (<option key={option.value} value={option.value}>{option.label}</option>))}
                </select>
            </div>
        );

        const ClientSearchInput = ({ clients, value, onChange, required = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const sortedClients = useMemo(() => [...clients].sort((a, b) => (a.ragioneSociale || '').localeCompare(b.ragioneSociale || '')), [clients]);
            const filteredOptions = sortedClients.filter(c => (c.ragioneSociale || '').toLowerCase().includes((value || '').toLowerCase()));

            return (
                <div className="relative">
                    <label className="block text-sm font-bold text-gray-700 mb-1">Cliente {required && '*'}</label>
                    <input
                        type="text"
                        name="client"
                        value={value || ''}
                        onChange={(e) => { onChange(e); setIsOpen(true); }}
                        onFocus={() => setIsOpen(true)}
                        onBlur={() => setTimeout(() => setIsOpen(false), 200)}
                        required={required}
                        placeholder="Cerca o seleziona cliente..."
                        className="w-full p-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow"
                        autoComplete="off"
                    />
                    {isOpen && filteredOptions.length > 0 && (
                        <div className="absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto">
                            {filteredOptions.map(c => (
                                <div 
                                    key={c.id}
                                    onClick={() => { onChange({ target: { name: 'client', value: c.ragioneSociale } }); setIsOpen(false); }}
                                    className="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 text-sm text-gray-700 font-medium active:bg-blue-100"
                                >
                                    {c.ragioneSociale}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const TimeWheelPicker = ({ value, onChange }) => {
            const hVal = Math.floor(parseFloat(value) || 0);
            const mVal = Math.round(((parseFloat(value) || 0) - hVal) * 60);
            const hours = [...Array(13).keys()]; 
            const minutes = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
            const itemHeight = 40; const spacerHeight = 40;

            const handleScroll = (e, type) => {
                const index = Math.round(e.target.scrollTop / itemHeight);
                if (type === 'h') {
                    const newH = hours[index] !== undefined ? hours[index] : hVal;
                    updateTime(newH, mVal);
                } else {
                    const newM = minutes[index] !== undefined ? minutes[index] : mVal;
                    updateTime(hVal, newM);
                }
            };

            const updateTime = (h, m) => {
                const decimal = (h + (m / 60)).toFixed(2);
                onChange(parseFloat(decimal).toString());
            };
            
            const hRef = useRef(null);
            const mRef = useRef(null);

            useEffect(() => {
                if(hRef.current) hRef.current.scrollTop = hours.indexOf(hVal) * itemHeight;
                if(mRef.current) mRef.current.scrollTop = minutes.indexOf(mVal) * itemHeight;
            }, []);

            return (
                <div>
                     <label className="block text-sm font-bold text-gray-700 mb-2">Durata</label>
                    <div className="flex justify-center gap-2 py-4 relative bg-white rounded-xl border border-gray-200 select-none shadow-inner">
                        <div className="absolute top-1/2 -translate-y-1/2 w-full h-[40px] bg-blue-100/50 pointer-events-none border-y border-blue-200"></div>
                        <div className="w-24 h-[120px] overflow-y-auto snap-y snap-mandatory wheel-scroller relative z-10 text-center" onScroll={(e) => handleScroll(e, 'h')} ref={hRef}>
                            <div style={{ height: spacerHeight }} />{hours.map(h => (<div key={h} className="h-[40px] flex items-center justify-center font-bold text-gray-700 snap-center">{h} <span className="text-xs text-gray-400 ml-1 font-normal">ore</span></div>))}<div style={{ height: spacerHeight }} />
                        </div>
                        <div className="h-[120px] flex items-center justify-center text-gray-300 font-light text-2xl pb-1">:</div>
                        <div className="w-24 h-[120px] overflow-y-auto snap-y snap-mandatory wheel-scroller relative z-10 text-center" onScroll={(e) => handleScroll(e, 'm')} ref={mRef}>
                            <div style={{ height: spacerHeight }} />{minutes.map(m => (<div key={m} className="h-[40px] flex items-center justify-center font-bold text-gray-700 snap-center">{m} <span className="text-xs text-gray-400 ml-1 font-normal">min</span></div>))}<div style={{ height: spacerHeight }} />
                        </div>
                    </div>
                </div>
            );
        };

        const SectionContainer = ({ title, icon: Icon, children }) => (
            <section className="bg-white p-5 rounded-2xl shadow-md border border-gray-100 space-y-4">
                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">{Icon && <Icon size={14} />} {title}</h3>
                {children}
            </section>
        );
        
        const SectionDisplay = ({ title, content, small = false }) => (
            <div className="space-y-2">
                <h3 className={`font-bold ${small ? 'text-xs uppercase text-gray-500 tracking-wide' : 'text-sm text-gray-700'}`}>{title}</h3>
                <p className={`whitespace-pre-wrap ${small ? 'text-sm text-gray-600' : 'text-base text-gray-800'} p-3 bg-gray-50 rounded-lg border border-gray-100`}>{content || 'Nessuna descrizione fornita.'}</p>
            </div>
        );

        const SectionTitle = ({ title, icon }) => (
            <h2 className="text-base font-bold text-gray-700 border-b border-gray-200 pb-2 flex items-center gap-2">{icon} {title}</h2>
        );

        const generateICSFile = (title, description, startDateTime, endDateTime, uid, sequence = 0, location = "") => {
             const formatDate = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');
             const eventUid = uid || `${Date.now()}@crm.app`; 
             const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//WorkReport CRM//IT\nBEGIN:VEVENT\nUID:${eventUid}\nSEQUENCE:${sequence}\nDTSTAMP:${formatDate(new Date())}\nDTSTART:${formatDate(startDateTime)}\nDTEND:${formatDate(endDateTime)}\nSUMMARY:${title}\nDESCRIPTION:${description}\nLOCATION:${location}\nEND:VEVENT\nEND:VCALENDAR`;
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', `${title.replace(/\s+/g, '_')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const CalendarButton = ({ title, details, date, time = "09:00", duration = 60, uid, sequence = 0 }) => {
            if (!date) return null;
            const start = new Date(`${date}T${time}`);
            const end = new Date(start.getTime() + duration * 60000);
            const openGoogle = () => {
                const text = encodeURIComponent(title);
                const det = encodeURIComponent(details);
                const dates = `${start.toISOString().replace(/-|:|\.\d{3}/g, '')}/${end.toISOString().replace(/-|:|\.\d{3}/g, '')}`;
                window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${det}&dates=${dates}`, '_blank');
            };
            const downloadICS = () => generateICSFile(title, details, start, end, uid, sequence);
            return (
                <div className="flex flex-col gap-1 mt-3">
                    <div className="flex gap-2">
                        <button type="button" onClick={openGoogle} className="flex-1 flex justify-center items-center gap-2 px-3 py-3 bg-indigo-50 text-indigo-600 font-bold rounded-xl border border-indigo-100 active:scale-[0.98] transition-all hover:bg-indigo-100 shadow-sm text-xs"><Icons.Calendar size={16} /> Google Cal</button>
                        <button type="button" onClick={downloadICS} className="flex-1 flex justify-center items-center gap-2 px-3 py-3 bg-gray-50 text-gray-700 font-bold rounded-xl border border-gray-200 active:scale-[0.98] transition-all hover:bg-gray-100 shadow-sm text-xs"><Icons.Download size={16} /> Scarica .ics</button>
                    </div>
                </div>
            );
        };

        const DashboardView = () => {
            const { clients, followups, ideas, setView, setFollowupForm, setIdeaForm, fileInputRef, handleImport, exportToExcel, handleCleanDuplicates, handleLogout } = useContext(CRMContext);
            return (
                <div className="space-y-6 animate-fade-in pb-32">
                    <header className="mb-6"><h1 className="text-2xl font-bold text-gray-800">Dashboard</h1></header>
                    <div className="grid grid-cols-3 md:grid-cols-4 gap-4">
                        <div className="bg-white p-5 rounded-2xl shadow-md border border-gray-100"><div className="flex items-center space-x-2 mb-2 text-blue-600"><Icons.Users size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Clienti</span></div><div className="text-3xl font-bold text-gray-800">{clients.length}</div></div>
                        <div className="bg-white p-5 rounded-2xl shadow-md border border-gray-100"><div className="flex items-center space-x-2 mb-2 text-yellow-600"><Icons.Target size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Offerte</span></div><div className="text-3xl font-bold text-gray-800">{followups.length}</div></div>
                        <div className="bg-white p-5 rounded-2xl shadow-md border border-gray-100"><div className="flex items-center space-x-2 mb-2 text-red-600"><Icons.Lightbulb size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Idee</span></div><div className="text-3xl font-bold text-gray-800">{ideas.length}</div></div>
                    </div>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center text-center">
                        <button onClick={() => setView('create')} className="w-full bg-gray-600 hover:bg-gray-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-gray-300 flex justify-center items-center gap-2 active:scale-95 transition-all mb-3 text-lg"><Icons.Plus size={22} /> Nuovo Report</button>
                        <button onClick={() => setView('list')} className="w-full text-gray-600 font-bold bg-gray-50 py-3 rounded-xl border border-gray-200 active:scale-95 transition-transform hover:bg-gray-100 flex justify-center items-center gap-2 shadow-sm"> <Icons.ClipboardList size={18} /> Storico Report</button>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center text-center">
                        <button onClick={() => { setFollowupForm({}); setView('createFollowup'); }} className="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-yellow-100 flex justify-center items-center gap-2 active:scale-95 transition-all mb-3 text-lg"><Icons.Plus size={22} /> Nuova Offerta</button>
                        <button onClick={() => setView('followups')} className="w-full text-yellow-700 font-bold bg-yellow-50 py-3 rounded-xl border border-yellow-100 active:scale-95 transition-transform hover:bg-yellow-100 flex justify-center items-center gap-2 shadow-sm"><Icons.ClipboardList size={18} /> Storico Offerte</button>
                    </div>

                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col items-center text-center">
                        <button onClick={() => { setIdeaForm({}); setView('createIdea'); }} className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-red-100 flex justify-center items-center gap-2 active:scale-95 transition-all mb-3 text-lg"><Icons.Plus size={22} /> Nuova Idea</button>
                        <button onClick={() => setView('ideas')} className="w-full text-red-700 font-bold bg-red-50 py-3 rounded-xl border border-red-100 active:scale-95 transition-transform hover:bg-red-100 flex justify-center items-center gap-2 shadow-sm"><Icons.ClipboardList size={18} /> Storico Idee</button>
                    </div>

                    <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onClick={() => fileInputRef.current.click()} className="text-xs text-blue-600 p-3 bg-white border border-gray-200 rounded-xl flex items-center justify-center gap-1 font-bold shadow-sm active:scale-95"><Icons.Upload size={16} /> Importa</button>
                        <button onClick={exportToExcel} className="text-xs text-green-600 p-3 bg-white border border-gray-200 rounded-xl flex items-center justify-center gap-1 font-bold shadow-sm active:scale-95"><Icons.Download size={16} /> Backup</button>
                        <button onClick={handleCleanDuplicates} className="text-xs text-purple-600 p-3 bg-white border border-gray-200 rounded-xl flex items-center justify-center gap-1 font-bold shadow-sm active:scale-95"><Icons.Trash2 size={16} /> Pulisci</button>
                        <button onClick={handleLogout} className="text-xs text-red-500 p-3 bg-white border border-gray-200 rounded-xl flex items-center justify-center gap-1 font-bold shadow-sm active:scale-95"><Icons.LogOut size={16} /> Esci</button>
                    </div>
                </div>
            );
        };

        const TodoView = () => {
             const { reports, followups, ideas, setSelectedReport, setFollowupForm, setIdeaForm, setView, toggleTaskCompletion } = useContext(CRMContext);
             const [search, setSearch] = useState('');
             const todos = useMemo(() => {
                 const items = [];
                 reports.forEach(r => { if (r.nextContactDate && !r.completed) items.push({ type: 'report', date: new Date(`${r.nextContactDate}T${r.nextContactTime || '09:00'}`), data: r, label: 'Contatto', icon: Icons.Phone, collection: 'reports' }); });
                 followups.forEach(f => { if (f.feedbackDate && !f.completed) items.push({ type: 'offer', date: new Date(f.feedbackDate), data: f, label: 'Riscontro Offerta', icon: Icons.Target, collection: 'followups' }); });
                 ideas.forEach(i => { if (i.deadline && !i.completed) items.push({ type: 'idea', date: new Date(i.deadline), data: i, label: 'Scadenza Idea', icon: Icons.Lightbulb, collection: 'ideas' }); });
                 return items.sort((a, b) => a.date - b.date);
             }, [reports, followups, ideas]);
             const filteredTodos = todos.filter(item => { const s = search.toLowerCase(); return (item.data.client || '').toLowerCase().includes(s) || (item.data.description || item.data.notes || item.data.text || item.data.futureNotes || '').toLowerCase().includes(s); });
             const handleItemClick = (item) => {
                 if (item.type === 'report') { setSelectedReport(item.data); setView('detail'); } 
                 else if (item.type === 'offer') { setFollowupForm(item.data); setView('createFollowup'); } 
                 else if (item.type === 'idea') { setIdeaForm(item.data); setView('createIdea'); }
             };
            return (
                <div className="animate-fade-in pb-32">
                    <header className="mb-6 flex justify-between items-center"><h1 className="text-2xl font-bold text-gray-800">Da Fare</h1><div className="bg-gray-800 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">{todos.length} Attività</div></header>
                    <div className="mb-4 relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div><input type="text" placeholder="Cerca attività..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none shadow-sm" /></div>
                    <div className="space-y-3">{filteredTodos.map((item, idx) => (<div key={`${item.type}-${item.data.id}-${idx}`} onClick={() => handleItemClick(item)} className={`p-4 rounded-xl border cursor-pointer active:scale-[0.99] transition-transform shadow-md bg-white border-gray-100`}><div className="flex justify-between items-start"><div className="flex-1 min-w-0 pr-2"><div className="flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-gray-400 mb-1"><item.icon size={12} /> {item.label}</div><div className="font-bold text-lg text-gray-800 truncate mb-1">{item.data.client}</div><div className="text-sm text-gray-500 truncate">{item.type === 'report' ? (item.data.futureNotes || item.data.description) : (item.data.notes || item.data.text || item.data.description)}</div></div><div className="text-right shrink-0 flex flex-col items-end gap-2"><div><div className="font-bold text-lg text-gray-700 leading-none">{item.date.getDate()}</div><div className="text-xs font-bold uppercase text-gray-400">{item.date.toLocaleString('it-IT', { month: 'short' })}</div></div><button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion(item.collection, item.data.id, false); }} className="bg-red-500 text-white p-2 rounded-full shadow-lg hover:bg-red-600 transition-colors"><Icons.Check size={16} /></button></div></div></div>))}</div>
                </div>
            );
        };

        const ReportForm = () => {
            const { reportForm: initialData, saveReport, setView, clients } = useContext(CRMContext);
            const [formData, setFormData] = useState(initialData);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value, ...(name === 'client' ? {contactRef: ''} : {}) })); };
            const handleSubmit = (e) => { e.preventDefault(); saveReport(formData); };
            const selectedClientData = useMemo(() => clients.find(c => c.ragioneSociale === formData.client), [clients, formData.client]);
            const availableContacts = selectedClientData ? [selectedClientData.contact1, selectedClientData.contact2, selectedClientData.contact3, selectedClientData.contact4].filter(c => c?.nome) : [];

            const getEventDuration = (type) => {
                switch(type) {
                    case 'PROMEMORIA': return 5;
                    case 'TELEFONATA': return 15;
                    case 'APPUNTAMENTO': return 60;
                    default: return 60;
                }
            };

            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica' : 'Nuovo'} Report</h2>
                    <form onSubmit={handleSubmit} className="space-y-5">
                        <SectionContainer title="Dati" icon={Icons.FileText}>
                            <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                            {availableContacts.length > 0 && (<div><label className="block text-sm font-bold text-gray-700 mb-1">Referente</label><select name="contactRef" value={formData.contactRef} onChange={handleChange} className="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none"><option value="">Nessuno spec.</option>{availableContacts.map((c, idx) => (<option key={idx} value={c.nome}>{c.nome} {c.mansione ? `(${c.mansione})` : ''}</option>))}</select></div>)}
                            <div className="grid grid-cols-2 gap-4"><Input label="Data" type="date" name="date" value={formData.date} onChange={handleChange} required /><TimeWheelPicker value={formData.hours} onChange={(val) => setFormData(prev => ({...prev, hours: val}))} /></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Categoria</label><select name="category" value={formData.category} onChange={handleChange} className="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none"><option>MANTENIMENTO RAPPORTO</option><option>ORDINE</option><option>RICHIESTA DI OFFERTA</option><option>RISCONTRO OFFERTA</option><option>COMUNICAZIONE</option><option>INIZIO RAPPORTO FORNITURE</option><option>SOLLECITO INIZIO FORNITURA</option><option>APPUNTAMENTO</option><option>ALTRO</option></select></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Tipo</label><select name="contactType" value={formData.contactType} onChange={handleChange} className="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none"><option>TELEFONICO</option><option>APPUNTAMENTO</option><option>VISITA</option><option>LINKEDIN</option><option>WHATSAPP</option><option>CANTIERE</option><option>ALTRO</option></select></div>
                            <TextArea label="Descrizione" name="description" value={formData.description} onChange={handleChange} />
                        </SectionContainer>
                        <SectionContainer title="Follow-up" icon={Icons.AlarmCheck}>
                            <div><label className="block text-sm font-bold text-gray-700 mb-2">Tipo Promemoria</label><div className="flex gap-2 mb-3">{['APPUNTAMENTO', 'PROMEMORIA', 'TELEFONATA'].map(type => (<button key={type} type="button" onClick={() => setFormData(p => ({ ...p, calendarEventType: type }))} className={`flex-1 py-3 text-xs font-bold rounded-lg border transition-all shadow-sm ${formData.calendarEventType === type ? 'bg-gray-600 text-white border-gray-600' : 'bg-white text-gray-600 border-gray-200'}`}>{type}</button>))}</div></div>
                            <TextArea label="Appunti Futuri" name="futureNotes" value={formData.futureNotes} onChange={handleChange} />
                            <div className="grid grid-cols-2 gap-4"><Input label="Data" type="date" name="nextContactDate" value={formData.nextContactDate} onChange={handleChange} /><Input label="Ora" type="time" name="nextContactTime" value={formData.nextContactTime} onChange={handleChange} /></div>
                            <CalendarButton title={`${formData.calendarEventType} - ${formData.client}`} details={formData.futureNotes} date={formData.nextContactDate} time={formData.nextContactTime} duration={getEventDuration(formData.calendarEventType)} uid={formData.calendarUid} sequence={formData.calendarSequence} />
                        </SectionContainer>
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView('dashboard')} className="flex-1 py-3 bg-white text-gray-700 font-bold rounded-xl shadow-md">Annulla</button><button type="submit" className="flex-1 py-3 bg-gray-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const ReportList = () => {
             const { reports, toggleSort, sortOrder, setReportForm, setView, setSelectedReport, formatDuration, toggleTaskCompletion } = useContext(CRMContext);
             const [search, setSearch] = useState('');
             const filtered = reports.filter(r => (r.client||'').toLowerCase().includes(search.toLowerCase()) || (r.description||'').toLowerCase().includes(search.toLowerCase()));
             const sorted = [...filtered].sort((a,b) => {
                 const dateA = new Date(a.date).getTime(); const dateB = new Date(b.date).getTime();
                 if (sortOrder.reports === 'desc') return dateB - dateA;
                 return dateA - dateB;
             });

             return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-gray-800">Storico</h2><div className="flex gap-2"><button onClick={() => toggleSort('reports')} className="bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 shadow-sm flex items-center gap-1"><Icons.ArrowUpDown size={14} /> {sortOrder.reports === 'desc' ? 'Recenti' : 'Vecchi'}</button><button onClick={() => { setReportForm({}); setView('create'); }} className="bg-gray-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 shadow-md"><Icons.Plus size={14} /> Nuovo</button></div></div>
                     <div className="mb-4 relative"><input type="text" placeholder="Cerca..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none shadow-sm" /><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div></div>
                    <div className="space-y-3">{sorted.map(r => (<div key={r.id} onClick={() => { setSelectedReport(r); setView('detail'); }} className={`p-4 rounded-xl border relative cursor-pointer active:scale-[0.99] transition-transform shadow-md bg-white border-gray-100`}><div className="flex justify-between"><h3 className="font-bold text-gray-800 truncate pr-4">{r.client}</h3><span className="font-bold text-gray-600 shrink-0">{formatDuration(r.hours)}</span></div><div className="text-sm text-gray-500 flex justify-between mt-1"><span>{r.category}</span><div className="flex items-center gap-2"><span className="text-xs">{new Date(r.date).toLocaleDateString('it-IT')}</span>{r.nextContactDate && (<button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion('reports', r.id, r.completed); }} className={`p-1.5 rounded-full text-white shadow-md transition-colors ${r.completed ? 'bg-green-500' : 'bg-red-500'}`}><Icons.Check size={12} /></button>)}</div></div></div>))}</div>
                </div>
             );
        };

        const ClientDetailView = () => {
            const { selectedClient, setView, setClientForm, setReportForm, setFollowupForm, setIdeaForm, deleteItem } = useContext(CRMContext);
            if (!selectedClient) return null;
            const getFullPaymentMethod = (client) => [client.paymentMethod1, client.paymentMethod2, client.paymentMethod3].filter(Boolean).join(' - ') || 'Non Specificato';
            const handleNewReport = () => { setReportForm({ client: selectedClient.ragioneSociale, date: new Date().toISOString().split('T')[0], category: 'MANTENIMENTO RAPPORTO', contactType: 'TELEFONICO', calendarEventType: 'APPUNTAMENTO' }); setView('create'); };
            const handleNewOffer = () => { setFollowupForm({ client: selectedClient.ragioneSociale }); setView('createFollowup'); };
            const handleNewIdea = () => { setIdeaForm({ client: selectedClient.ragioneSociale }); setView('createIdea'); };

            return (
                <div className="animate-fade-in pb-32">
                    <div className="sticky top-0 bg-gray-200/90 backdrop-blur z-10 p-4 mb-2 flex justify-between items-center border-b border-gray-300">
                        <button onClick={() => setView('clients')} className="p-2 -ml-2 rounded-full hover:bg-white/50"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <div className="flex gap-2">
                            <button onClick={() => { setClientForm(selectedClient); setView('createClient'); }} className="p-2 text-blue-600 bg-white rounded-full shadow-sm"><Icons.Edit2 size={20}/></button>
                            <button onClick={() => deleteItem('clients', selectedClient.id)} className="p-2 text-red-500 bg-white rounded-full shadow-sm"><Icons.Trash2 size={20}/></button>
                        </div>
                    </div>
                    <div className="px-4 space-y-4">
                        <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                            <h1 className="text-2xl font-bold text-gray-900 leading-tight mb-1">{selectedClient.ragioneSociale}</h1>
                            <p className="text-sm text-gray-400 font-semibold tracking-wide">P.IVA: {selectedClient.pIva || '-'}</p>
                            <div className="mt-4 flex flex-wrap gap-2">
                                {selectedClient.telefono && <a href={`tel:${selectedClient.telefono}`} className="bg-green-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md shadow-green-100 flex items-center gap-2 transition-transform active:scale-95"><Icons.Phone size={14}/> Chiama</a>}
                                {selectedClient.email && <a href={`mailto:${selectedClient.email}`} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md shadow-blue-100 flex items-center gap-2 transition-transform active:scale-95"><Icons.Mail size={14}/> Email</a>}
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={handleNewReport} className="flex flex-col items-center justify-center p-5 bg-white border border-gray-100 rounded-2xl shadow-md active:scale-95 transition-transform"><div className="bg-blue-50 p-2 rounded-full mb-2 text-blue-600"><Icons.FileText size={20} /></div><span className="text-xs font-bold text-gray-800">Report</span></button>
                            <button onClick={() => setView('clientReports')} className="flex flex-col items-center justify-center p-5 bg-white border border-gray-100 rounded-2xl shadow-md active:scale-95 transition-transform"><div className="bg-gray-50 p-2 rounded-full mb-2 text-gray-600"><Icons.ClipboardList size={20} /></div><span className="text-xs font-bold text-gray-800">Storico</span></button>
                            <button onClick={handleNewOffer} className="flex flex-col items-center justify-center p-5 bg-white border border-gray-100 rounded-2xl shadow-md active:scale-95 transition-transform"><div className="bg-yellow-50 p-2 rounded-full mb-2 text-yellow-600"><Icons.Target size={20} /></div><span className="text-xs font-bold text-yellow-800">Offerta</span></button>
                            <button onClick={handleNewIdea} className="flex flex-col items-center justify-center p-5 bg-white border border-gray-100 rounded-2xl shadow-md active:scale-95 transition-transform"><div className="bg-red-50 p-2 rounded-full mb-2 text-red-600"><Icons.Lightbulb size={20} /></div><span className="text-xs font-bold text-red-800">Idea</span></button>
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-md border border-gray-100 space-y-4">
                            <SectionTitle icon={<Icons.CreditCard size={16}/>} title="Dati Amministrativi" />
                            <div className="grid grid-cols-1 gap-3">
                                <InfoRow label="Univoco" value={selectedClient.sdiCode} /><InfoRow label="PEC" value={selectedClient.pec} /><InfoRow label="Fido (€)" value={selectedClient.fido} />
                                <div className="pt-2"><label className="text-xs text-gray-400 font-bold uppercase">Pagamento</label><div className="text-sm font-semibold text-gray-800">{getFullPaymentMethod(selectedClient)}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ClientsList = () => {
            const { sortedClients, setView, setSelectedClient } = useContext(CRMContext);
            const [search, setSearch] = useState('');
            const filtered = sortedClients.filter(c => (c.ragioneSociale || '').toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-gray-800">Clienti</h2><button onClick={() => setView('createClient')} className="bg-gray-900 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md flex items-center gap-1"><Icons.Plus size={14} /> Nuovo</button></div>
                    <div className="mb-4 relative"><input type="text" placeholder="Cerca..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none shadow-sm" /><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div></div>
                    <div className="space-y-3">{filtered.map(c => (<div key={c.id} onClick={() => { setSelectedClient(c); setView('clientDetail'); }} className="bg-white p-5 rounded-2xl shadow-md border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform"><h3 className="font-bold text-gray-800 text-lg leading-tight mb-1">{c.ragioneSociale}</h3><div className="text-xs text-gray-400 font-medium uppercase tracking-wide">{c.sedeOperativa || 'Sede non spec.'}</div></div>))}</div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [userKey, setUserKey] = useState(localStorage.getItem('crm_user_key') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(!!userKey);
            const [view, setView] = useState('dashboard');
            const [clients, setClients] = useState([]);
            const [reports, setReports] = useState([]);
            const [followups, setFollowups] = useState([]);
            const [ideas, setIdeas] = useState([]);
            const [selectedReport, setSelectedReport] = useState(null);
            const [selectedClient, setSelectedClient] = useState(null);
            const [reportForm, setReportForm] = useState({});
            const [clientForm, setClientForm] = useState({});
            const [followupForm, setFollowupForm] = useState({});
            const [ideaForm, setIdeaForm] = useState({});
            const [sortOrder, setSortOrder] = useState({ reports: 'desc', clients: 'asc', followups: 'desc', ideas: 'desc' });
            const [message, setMessage] = useState({ text: '', type: '' });
            const [showCleanModal, setShowCleanModal] = useState(false);
            const [duplicatesData, setDuplicatesData] = useState([]);
            const fileInputRef = useRef(null);
            
            useEffect(() => { const app = initializeApp(firebaseConfig); setDb(getFirestore(app)); onAuthStateChanged(getAuth(app), u => !u && signInAnonymously(getAuth(app))); }, []);
            useEffect(() => {
                if (!db || !userKey) return;
                const key = userKey.toLowerCase().replace(/\s/g, '');
                const subs = [ onSnapshot(collection(db, `artifacts/${appId}/users/${key}/reports`), s => setReports(s.docs.map(d => ({ ...d.data(), id: d.id })))), onSnapshot(collection(db, `artifacts/${appId}/users/${key}/clients`), s => setClients(s.docs.map(d => ({ ...d.data(), id: d.id })))), onSnapshot(collection(db, `artifacts/${appId}/users/${key}/followups`), s => setFollowups(s.docs.map(d => ({ ...d.data(), id: d.id })))), onSnapshot(collection(db, `artifacts/${appId}/users/${key}/ideas`), s => setIdeas(s.docs.map(d => ({ ...d.data(), id: d.id })))) ];
                return () => subs.forEach(unsub => unsub());
            }, [db, userKey]);

            const sortedClients = useMemo(() => { const s = [...clients].sort((a,b) => (a.ragioneSociale||'').localeCompare(b.ragioneSociale||'')); return sortOrder.clients === 'desc' ? s.reverse() : s; }, [clients, sortOrder.clients]);
            const showMessage = (text, type='info') => { setMessage({text, type}); setTimeout(() => setMessage({text:'', type:''}), 3000); };
            const toggleSort = (k) => setSortOrder(p => ({ ...p, [k]: p[k] === 'desc' ? 'asc' : 'desc' }));
            
            const saveReport = async (data) => { const key = userKey.toLowerCase().replace(/\s/g, ''); const id = data.id || String(Date.now()); const title = data.title || `${data.category} - ${data.date}`; await setDoc(doc(db, `artifacts/${appId}/users/${key}/reports`, id), { ...data, id, title, createdAt: data.createdAt || new Date().toISOString() }); showMessage('Salvato', 'success'); setView('list'); };
            const saveClient = async (data) => { const key = userKey.toLowerCase().replace(/\s/g, ''); const id = data.id || String(Date.now()); await setDoc(doc(db, `artifacts/${appId}/users/${key}/clients`, id), { ...data, id, updatedAt: new Date().toLocaleDateString('it-IT') }); showMessage('Salvato', 'success'); setView('clients'); };
            const deleteItem = async (col, id) => { if (window.confirm("Eliminare?")) { await deleteDoc(doc(db, `artifacts/${appId}/users/${userKey.toLowerCase().replace(/\s/g, '')}/${col}`, id)); showMessage('Eliminato'); return true; } return false; };
            const toggleTaskCompletion = async (col, id, stat) => { await setDoc(doc(db, `artifacts/${appId}/users/${userKey.toLowerCase().replace(/\s/g, '')}/${col}`, id), { completed: !stat }, { merge: true }); };
            const handleLogout = () => { localStorage.removeItem('crm_user_key'); setUserKey(''); setIsLoggedIn(false); setView('dashboard'); };
            const handleLogin = (e) => { e.preventDefault(); const val = e.target.elements[0].value.trim(); if(val) { localStorage.setItem('crm_user_key', val); setUserKey(val); setIsLoggedIn(true); } };
            const exportToExcel = () => { if(!XLSX) return; const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clients), "Clienti"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(reports), "Report"); XLSX.writeFile(wb, `Backup.xlsx`); showMessage('Backup scaricato'); };
            const formatDuration = (val) => { const num = parseFloat(val) || 0; const h = Math.floor(num); const m = Math.round((num - h) * 60); return h > 0 ? `${h}h ${m}m` : `${m}m`; };

            if (!isLoggedIn) return ( <div className="min-h-screen bg-gray-300 flex justify-center items-center p-4"> <form onSubmit={handleLogin} className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center"> <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 shadow-md"><Icons.Lock size={32}/></div> <h1 className="text-2xl font-bold mb-2">WorkReport CRM</h1> <input type="text" placeholder="Chiave" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center font-bold outline-none border focus:border-blue-500 shadow-inner" autoFocus/> <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform">Accedi</button> </form> </div> );

            return (
                <CRMContext.Provider value={{ db, userKey, view, setView, clients, reports, followups, ideas, sortedClients, sortOrder, toggleSort, selectedReport, setSelectedReport, selectedClient, setSelectedClient, reportForm, setReportForm, clientForm, setClientForm, followupForm, setFollowupForm, ideaForm, setIdeaForm, saveReport, saveClient, deleteItem, toggleTaskCompletion, fileInputRef, exportToExcel, handleLogout, formatDuration }}>
                    <div className="min-h-screen bg-gray-200 flex justify-center pt-0 sm:pt-6">
                        <div className="w-full max-w-7xl bg-gray-200 h-dvh sm:rounded-[2.5rem] sm:shadow-2xl overflow-hidden flex flex-col ring-8 ring-gray-900/5">
                            <div className="flex-1 overflow-y-auto scrollbar-hide p-6">
                                {view === 'dashboard' && <DashboardView />}
                                {view === 'todo' && <TodoView />}
                                {view === 'list' && <ReportList />}
                                {view === 'create' && <ReportForm />}
                                {view === 'clients' && <ClientsList />}
                                {view === 'clientDetail' && <ClientDetailView />}
                                {view === 'stats' && <div className="p-4 text-center text-gray-400">Statistiche in arrivo...</div>}
                            </div>
                            <nav className="border-t border-gray-300 p-3 bg-white shadow-2xl z-20"><div className="flex justify-around">{[{ id: 'dashboard', icon: Icons.LayoutDashboard, label: 'Home' }, { id: 'todo', icon: Icons.CheckSquare, label: 'TO-DO' }, { id: 'list', icon: Icons.ClipboardList, label: 'Storico' }, { id: 'clients', icon: Icons.Users, label: 'Clienti' }].map(item => (<button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center p-2 rounded-xl transition-all active:scale-95 ${view === item.id ? 'text-blue-600' : 'text-gray-400'}`}><item.icon size={24} className="mb-0.5" /><span className="text-[10px] font-bold">{item.label}</span></button>))}</div></nav>
                            {message.text && (<div className={`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-2xl text-white font-bold text-sm z-50 bg-blue-500`}>{message.text}</div>)}
                        </div>
                    </div>
                </CRMContext.Provider>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
