<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CRM WorkReport v1.0</title>
    
    <!-- 1. Stile Grafico (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Motore dell'App (React) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Traduttore Codice (Babel) - Versione bloccata per evitare errori di compatibilità -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <!-- 4. Libreria per Export Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .h-dvh { height: 100dvh; }
        /* Ottimizzazione rendering font e input */
        input, textarea, select { font-size: 16px !important; } /* Previene zoom su iOS */

        /* Stili per la Ruota Temporale */
        .wheel-scroller {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .wheel-scroller::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURAZIONE
        const appId = "miocrm-0001";
        const firebaseConfig = {
            apiKey: "AIzaSyAjP1UXwDJqAhWVjpb6ePrgtv3nQJ7fWFk",
            authDomain: "miocrm-0001.firebaseapp.com",
            projectId: "miocrm-0001",
            storageBucket: "miocrm-0001.firebasestorage.app",
            messagingSenderId: "880667208118",
            appId: "1:880667208118:web:d1d420b2d7d1743fde7917"
        };

        const { useState, useEffect, useMemo, useRef, useContext, createContext, useCallback } = React;

        // --- 0. UTILS ---
        const normalizeForSearch = (str) => (str || '').toLowerCase().replace(/[^a-z0-9]/g, '');

        // --- 1. CONTEXT ---
        const CRMContext = createContext();

        // --- 2. UTILITY COMPONENTS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        
        const Icons = {
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            LayoutDashboard: (p) => <IconBase {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Lightbulb: (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5a6 6 0 0 0-11 0c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Mail: (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>,
            Phone: (p) => <IconBase {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            Building2: (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>,
            MessageSquare: (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            Bell: (p) => <IconBase {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconBase>,
            AlarmCheck: (p) => <IconBase {...p}><circle cx="12" cy="13" r="8"/><path d="M5 3 2 6"/><path d="m22 6-3-3"/><path d="M6.38 18.7 4 21"/><path d="M17.64 18.67 20 21"/><path d="m9 13 2 2 4-4"/></IconBase>,
            Loader2: (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
            Check: (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>,
            ArrowUpDown: (p) => <IconBase {...p}><path d="m21 16-4 4-4-4"/><path d="m17 20V4"/><path d="m3 8 4-4 4 4"/><path d="m7 4v16"/></IconBase>,
            ClipboardList: (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>,
            BarChart: (p) => <IconBase {...p}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></IconBase>,
            CheckSquare: (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h11"/></IconBase>,
            BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
            Mic: (p) => <IconBase {...p}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></IconBase>,
            ShoppingBag: (p) => <IconBase {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" x2="21" y1="6" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>
        };

        const InfoBox = ({ label, value, icon: Icon, color = 'text-gray-700' }) => (
            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1 mb-1">{Icon && <Icon size={12} className={color} />} {label}</div>
                <div className={`text-lg font-semibold ${color}`}>{value || '-'}</div>
            </div>
        );

        const InfoRow = ({ label, value }) => (
            <div className="border-b border-gray-50 pb-2 last:border-0">
                <div className="text-xs text-gray-500 mb-1 uppercase tracking-wide">{label}</div>
                <div className="text-sm font-semibold text-gray-800 break-words whitespace-normal">{value || '-'}</div>
            </div>
        );

        const Input = ({ label, name, value, onChange, type = 'text', required = false, step = null, placeholder = '' }) => (
            <div>
                {label && <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>}
                <input type={type} name={name} value={value ?? ''} onChange={onChange} required={required} step={step} placeholder={placeholder} 
                    className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" />
            </div>
        );

        const TextArea = ({ label, name, value, onChange, placeholder = '', enableVoice = false }) => {
            const [isListening, setIsListening] = useState(false);

            const handleVoice = () => {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Riconoscimento vocale non supportato.");
                    return;
                }
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'it-IT';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = () => setIsListening(false);

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const cleanText = transcript.charAt(0).toUpperCase() + transcript.slice(1);
                    const newValue = value ? `${value} ${cleanText}` : cleanText;
                    onChange({ target: { name, value: newValue } });
                };
                
                recognition.start();
            };

            return (
                <div className="relative">
                    <div className="flex justify-between items-center mb-1">
                        <label className="block text-sm font-bold text-gray-700">{label}</label>
                        {enableVoice && (
                            <button type="button" onClick={handleVoice} className={`p-1 rounded-full transition-colors ${isListening ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} title="Dettatura vocale">
                                <Icons.Mic size={14} />
                            </button>
                        )}
                    </div>
                    <textarea name={name} value={value ?? ''} onChange={onChange} placeholder={placeholder} rows="3" 
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none transition-shadow" />
                </div>
            );
        };
        
        const SelectComponent = ({ label, name, value, onChange, options }) => (
            <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">{label}</label>
                <select name={name} value={value ?? ''} onChange={onChange} className="w-full p-2 bg-white border border-gray-200 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                    {options.map(option => (<option key={option.value} value={option.value}>{option.label}</option>))}
                </select>
            </div>
        );

        const ClientSearchInput = ({ clients, value, onChange, required = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const sortedClients = useMemo(() => [...clients].sort((a, b) => (a.ragioneSociale || '').localeCompare(b.ragioneSociale || '')), [clients]);
            
            const filteredOptions = sortedClients.filter(c => 
                normalizeForSearch(c.ragioneSociale).includes(normalizeForSearch(value))
            );

            return (
                <div className="relative">
                    <label className="block text-sm font-bold text-gray-700 mb-1">Cliente {required && '*'}</label>
                    <input
                        type="text"
                        name="client"
                        value={value || ''}
                        onChange={(e) => { onChange(e); setIsOpen(true); }}
                        onFocus={() => setIsOpen(true)}
                        onBlur={() => setTimeout(() => setIsOpen(false), 200)}
                        required={required}
                        placeholder="Cerca o seleziona cliente..."
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow"
                        autoComplete="off"
                    />
                    {isOpen && filteredOptions.length > 0 && (
                        <div className="absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                            {filteredOptions.map(c => (
                                <div 
                                    key={c.id}
                                    onClick={() => { onChange({ target: { name: 'client', value: c.ragioneSociale } }); setIsOpen(false); }}
                                    className="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 text-sm text-gray-700 font-medium active:bg-blue-100"
                                >
                                    {c.ragioneSociale}
                                </div>
                            ))}
                        </div>
                    )}
                     {isOpen && filteredOptions.length === 0 && (
                        <div className="absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg p-3 text-sm text-gray-400 text-center">Nessun cliente trovato</div>
                    )}
                </div>
            );
        };

        const TimeWheelPicker = ({ value, onChange }) => {
            const hVal = Math.floor(parseFloat(value) || 0);
            const mVal = Math.round(((parseFloat(value) || 0) - hVal) * 60);
            const hours = [...Array(13).keys()]; 
            const minutes = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
            const itemHeight = 40; const spacerHeight = 40;

            const handleScroll = (e, type) => {
                const index = Math.round(e.target.scrollTop / itemHeight);
                if (type === 'h') {
                    const newH = hours[index] !== undefined ? hours[index] : hVal;
                    updateTime(newH, mVal);
                } else {
                    const newM = minutes[index] !== undefined ? minutes[index] : mVal;
                    updateTime(hVal, newM);
                }
            };

            const updateTime = (h, m) => {
                const decimal = (h + (m / 60)).toFixed(2);
                onChange(parseFloat(decimal).toString());
            };
            
            const hRef = useRef(null);
            const mRef = useRef(null);

            useEffect(() => {
                if(hRef.current) hRef.current.scrollTop = hours.indexOf(hVal) * itemHeight;
                if(mRef.current) mRef.current.scrollTop = minutes.indexOf(mVal) * itemHeight;
            }, []);

            return (
                <div>
                     <label className="block text-sm font-bold text-gray-700 mb-2">Durata</label>
                    <div className="flex justify-center gap-2 py-4 relative bg-gray-50 rounded-xl border border-gray-200 select-none">
                        <div className="absolute top-1/2 -translate-y-1/2 w-full h-[40px] bg-blue-100/50 pointer-events-none border-y border-blue-200"></div>
                        <div className="w-24 h-[120px] overflow-y-auto snap-y snap-mandatory wheel-scroller relative z-10 text-center" onScroll={(e) => handleScroll(e, 'h')} ref={hRef}>
                            <div style={{ height: spacerHeight }} />{hours.map(h => (<div key={h} className="h-[40px] flex items-center justify-center font-bold text-gray-700 snap-center transition-colors">{h} <span className="text-xs text-gray-400 ml-1 font-normal">ore</span></div>))}<div style={{ height: spacerHeight }} />
                        </div>
                        <div className="h-[120px] flex items-center justify-center text-gray-300 font-light text-2xl pb-1">:</div>
                        <div className="w-24 h-[120px] overflow-y-auto snap-y snap-mandatory wheel-scroller relative z-10 text-center" onScroll={(e) => handleScroll(e, 'm')} ref={mRef}>
                            <div style={{ height: spacerHeight }} />{minutes.map(m => (<div key={m} className="h-[40px] flex items-center justify-center font-bold text-gray-700 snap-center transition-colors">{m} <span className="text-xs text-gray-400 ml-1 font-normal">min</span></div>))}<div style={{ height: spacerHeight }} />
                        </div>
                    </div>
                </div>
            );
        };

        const SectionContainer = ({ title, icon: Icon, children }) => (
            <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">{Icon && <Icon size={14} />} {title}</h3>
                {children}
            </section>
        );
        
        const SectionDisplay = ({ title, content, small = false }) => (
            <div className="space-y-2">
                <h3 className={`font-bold ${small ? 'text-xs uppercase text-gray-500 tracking-wide' : 'text-sm text-gray-700'}`}>{title}</h3>
                <p className={`whitespace-pre-wrap ${small ? 'text-sm text-gray-600' : 'text-base text-gray-800'} p-3 bg-gray-50 rounded-lg border border-gray-100`}>{content || 'Nessuna descrizione fornita.'}</p>
            </div>
        );

        const SectionTitle = ({ title, icon }) => (
            <h2 className="text-base font-bold text-gray-700 border-b border-gray-200 pb-2 flex items-center gap-2">{icon} {title}</h2>
        );

        // --- 3. LOGICA DI CALENDARIO ---
        const generateICSFile = (title, description, startDateTime, endDateTime, uid, sequence = 0, location = "") => {
             const formatDate = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');
             const eventUid = uid || `${Date.now()}@crm.app`; 
             const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//WorkReport CRM//IT\nBEGIN:VEVENT\nUID:${eventUid}\nSEQUENCE:${sequence}\nDTSTAMP:${formatDate(new Date())}\nDTSTART:${formatDate(startDateTime)}\nDTEND:${formatDate(endDateTime)}\nSUMMARY:${title}\nDESCRIPTION:${description}\nLOCATION:${location}\nEND:VEVENT\nEND:VCALENDAR`;
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', `${title.replace(/\s+/g, '_')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const CalendarButton = ({ title, details, date, time = "09:00", duration = 60, uid, sequence = 0 }) => {
            if (!date) return null;
            const start = new Date(`${date}T${time}`);
            const end = new Date(start.getTime() + duration * 60000);
            const openGoogle = () => {
                const text = encodeURIComponent(title);
                const det = encodeURIComponent(details);
                const dates = `${start.toISOString().replace(/-|:|\.\d{3}/g, '')}/${end.toISOString().replace(/-|:|\.\d{3}/g, '')}`;
                window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${det}&dates=${dates}`, '_blank');
            };
            const downloadICS = () => generateICSFile(title, details, start, end, uid, sequence);
            return (
                <div className="flex flex-col gap-1 mt-3">
                    <div className="flex gap-2">
                        <button type="button" onClick={openGoogle} className="flex-1 flex justify-center items-center gap-2 px-3 py-3 bg-indigo-50 text-indigo-600 font-bold rounded-xl border border-indigo-100 active:scale-[0.98] transition-all hover:bg-indigo-100 text-xs"><Icons.Calendar size={16} /> Google Cal</button>
                        <button type="button" onClick={downloadICS} className="flex-1 flex justify-center items-center gap-2 px-3 py-3 bg-gray-50 text-gray-700 font-bold rounded-xl border border-gray-200 active:scale-[0.98] transition-all hover:bg-gray-100 text-xs"><Icons.Download size={16} /> Scarica .ics</button>
                    </div>
                    <div className="text-[10px] text-gray-400 text-center italic px-1">Nota: Google Cal Web crea sempre nuovi eventi. Usa .ics per aggiornare su Outlook/Apple.</div>
                </div>
            );
        };

        // --- 4. LISTE DATI ---
        const paymentOptions = {
            method1: [{ label: "BB (Bonifico Bancario)", value: "BB" }, { label: "RI.BA (Ricevuta Bancaria)", value: "RI.BA" }],
            method2: [{ label: "30 giorni", value: "30" }, { label: "60 giorni", value: "60" }, { label: "90 giorni", value: "90" }],
            method3: [{ label: "DF (Data Fattura)", value: "DF" }, { label: "DFFM (Data Fattura Fine Mese)", value: "DFFM" }, { label: "Anticipato", value: "Anticipato" }],
        };
        const sectorsList = ['PUBBLICO', 'PRIVATO', 'INFRASTRUTTURE', 'EDILIZIA INDUSTRIALE', 'IMPIANTISTICA', 'ALTRO'];
        const regionsList = ['Abruzzo', 'Basilicata', 'Calabria', 'Campania', 'Emilia-Romagna', 'Friuli-Venezia Giulia', 'Lazio', 'Liguria', 'Lombardia', 'Marche', 'Molise', 'Piemonte', 'Puglia', 'Sardegna', 'Sicilia', 'Toscana', 'Trentino-Alto Adige', 'Umbria', 'Valle d\'Aosta', 'Veneto'];
        const brandsList = ['HILTI', 'WURTH', 'MAKITA', 'BOSCH', 'BERNER'];
        const suppliesList = ['URGENZE', 'SCORTE', 'PIANIFICAZIONE', 'ALTRO'];

        // --- 5. COMPONENTI VISTA ---

        const ManualView = () => {
            const { setView } = useContext(CRMContext);
            return (
                <div className="animate-fade-in pb-32">
                     <div className="sticky top-0 bg-gray-100/95 backdrop-blur z-10 p-4 mb-4 flex items-center">
                        <button onClick={() => setView('dashboard')} className="p-2 -ml-2 rounded-full hover:bg-gray-200 mr-2"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <h1 className="text-xl font-bold text-gray-800">Manuale Utente</h1>
                    </div>
                    <div className="p-4 space-y-6">
                        <SectionContainer title="Benvenuto" icon={Icons.BookOpen}><p className="text-sm text-gray-600">Benvenuto nel CRM WorkReport Versione 1.0. Questa guida ti aiuterà a sfruttare al meglio tutte le funzionalità dell'applicazione.</p></SectionContainer>
                        <SectionContainer title="Dashboard" icon={Icons.LayoutDashboard}>
                            <p className="text-sm text-gray-600">La schermata principale offre accesso rapido alle funzioni principali:</p>
                            <ul className="list-disc pl-5 text-sm text-gray-600 space-y-1 mt-2">
                                <li><strong>Report (Grigio):</strong> Crea e visualizza i report delle visite/contatti.</li>
                                <li><strong>Offerte (Giallo):</strong> Gestisci le offerte inviate e i loro esiti.</li>
                                <li><strong>Idee (Rosso):</strong> Appunta velocemente idee o progetti futuri.</li>
                            </ul>
                        </SectionContainer>

                        <SectionContainer title="Colori e Stati" icon={Icons.Target}>
                            <p className="text-sm text-gray-600">Il sistema usa un codice colori per identificare rapidamente il tipo di attività:</p>
                            <div className="flex gap-2 mt-2">
                                <div className="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-bold border border-gray-200">Report</div>
                                <div className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold border border-yellow-200">Offerte</div>
                                <div className="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-bold border border-red-200">Idee</div>
                            </div>
                            <p className="text-sm text-gray-600 mt-2">Inoltre, le attività possono essere <strong>Da Fare</strong> (Rosso) o <strong>Completate</strong> (Verde).</p>
                        </SectionContainer>

                         <SectionContainer title="Lista TO-DO" icon={Icons.CheckSquare}>
                            <p className="text-sm text-gray-600">La tab TO-DO raccoglie automaticamente:</p>
                             <ul className="list-disc pl-5 text-sm text-gray-600 space-y-1 mt-2">
                                <li>Report con un prossimo contatto programmato.</li>
                                <li>Offerte in attesa di riscontro.</li>
                                <li>Idee non ancora realizzate.</li>
                            </ul>
                            <p className="text-sm text-gray-600 mt-2">Usa il pulsante di spunta per completare un'attività e rimuoverla dalla lista.</p>
                        </SectionContainer>

                        <SectionContainer title="Gestione Clienti" icon={Icons.Users}>
                            <p className="text-sm text-gray-600">Nella sezione Clienti puoi gestire l'anagrafica completa. Se mancano dati importanti (es. Email, P.IVA), vedrai un avviso <strong>"Anagrafica Incompleta"</strong> sulla scheda del cliente.</p>
                            <p className="text-sm text-gray-600 mt-2">Dalla scheda cliente, puoi creare rapidamente nuovi Report, Offerte o Idee già precompilati.</p>
                        </SectionContainer>

                        <SectionContainer title="Funzioni Avanzate" icon={Icons.Trash2}>
                            <ul className="list-disc pl-5 text-sm text-gray-600 space-y-1">
                                <li><strong>Pulisci:</strong> Rileva ed elimina i report duplicati.</li>
                                <li><strong>Backup/Importa:</strong> Salva i tuoi dati in Excel o ripristinali.</li>
                                <li><strong>Calendario:</strong> Esporta eventi su Google Calendar o scarica il file .ics per Outlook/Apple. Le Idee hanno una durata preimpostata di 5 minuti.</li>
                            </ul>
                        </SectionContainer>
                    </div>
                </div>
            );
        };

        const DashboardView = () => {
            const { clients, reports, followups, ideas, orders, setView, setFollowupForm, setIdeaForm, setOrderForm, fileInputRef, handleImport, exportToExcel, handleCleanDuplicates, handleLogout } = useContext(CRMContext);
            
            const totalOrders = useMemo(() => orders.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0), [orders]);

            return (
                <div className="space-y-6 animate-fade-in pb-32">
                    <header className="mb-6"><h1 className="text-2xl font-bold text-gray-800">Dashboard</h1></header>
                    
                    <div onClick={() => setView('ordersList')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:scale-95 transition-transform hover:shadow-md">
                        <div className="flex items-center space-x-2 text-blue-600">
                            <Icons.ShoppingBag size={24} />
                            <span className="text-xs font-bold uppercase text-gray-400">Totale Ordini</span>
                        </div>
                        <div className="text-3xl font-bold text-gray-800">€ {totalOrders.toFixed(2)}</div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onClick={() => setView('clients')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><div className="flex items-center space-x-2 mb-2 text-blue-600"><Icons.Users size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Clienti</span></div><div className="text-3xl font-bold text-gray-800">{clients.length}</div></div>
                        <div onClick={() => setView('followups')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><div className="flex items-center space-x-2 mb-2 text-yellow-600"><Icons.Target size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Offerte</span></div><div className="text-3xl font-bold text-gray-800">{followups.length}</div></div>
                        <div onClick={() => setView('ideas')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><div className="flex items-center space-x-2 mb-2 text-red-600"><Icons.Lightbulb size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Idee</span></div><div className="text-3xl font-bold text-gray-800">{ideas.length}</div></div>
                        <div onClick={() => setView('list')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><div className="flex items-center space-x-2 mb-2 text-gray-600"><Icons.ClipboardList size={16} /><span className="text-[10px] md:text-xs font-bold uppercase text-gray-400">Report</span></div><div className="text-3xl font-bold text-gray-800">{reports.length}</div></div>
                    </div>
                    
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center text-center gap-3">
                        <button onClick={() => setView('create')} className="w-full bg-gray-600 hover:bg-gray-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-gray-200 flex justify-center items-center gap-2 active:scale-95 transition-all text-lg"><Icons.Plus size={22} /> Nuovo Report</button>
                        <button onClick={() => { setFollowupForm({}); setView('createFollowup'); }} className="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-yellow-200 flex justify-center items-center gap-2 active:scale-95 transition-all text-lg"><Icons.Plus size={22} /> Nuova Offerta</button>
                        <button onClick={() => { setOrderForm({}); setView('createOrder'); }} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 flex justify-center items-center gap-2 active:scale-95 transition-all text-lg"><Icons.ShoppingBag size={22} /> Nuovo Ordine</button>
                        <button onClick={() => { setIdeaForm({}); setView('createIdea'); }} className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-red-200 flex justify-center items-center gap-2 active:scale-95 transition-all text-lg"><Icons.Plus size={22} /> Nuova Idea</button>
                    </div>

                    <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-3">
                         <input type="file" ref={fileInputRef} className="hidden" onChange={handleImport} accept=".xlsx, .xls, .csv" />
                        <button onClick={() => fileInputRef.current.click()} className="text-xs text-blue-600 p-3 bg-blue-50 rounded-xl flex items-center justify-center gap-1 font-bold transition-colors hover:bg-blue-100 active:scale-95"><Icons.Upload size={16} /> Importa</button>
                        <button onClick={exportToExcel} className="text-xs text-green-600 p-3 bg-green-50 rounded-xl flex items-center justify-center gap-1 font-bold transition-colors hover:bg-green-100 active:scale-95"><Icons.Download size={16} /> Backup</button>
                        <button onClick={handleCleanDuplicates} className="text-xs text-purple-600 p-3 bg-purple-50 rounded-xl flex items-center justify-center gap-1 font-bold transition-colors hover:bg-purple-100 active:scale-95"><Icons.Trash2 size={16} /> Pulisci</button>
                        <button onClick={handleLogout} className="text-xs text-red-500 p-3 bg-red-50 rounded-xl flex items-center justify-center gap-1 font-bold transition-colors hover:bg-red-100 active:scale-95"><Icons.LogOut size={16} /> Esci</button>
                    </div>
                     <div className="mt-4 flex justify-center"><button onClick={() => setView('manual')} className="text-xs text-gray-500 underline hover:text-gray-800 flex items-center gap-1 p-2"><Icons.BookOpen size={14} /> Guida all'uso</button></div>
                </div>
            );
        };

        const TodoView = () => {
             const { reports, followups, ideas, setSelectedReport, setFollowupForm, setIdeaForm, setView, toggleTaskCompletion } = useContext(CRMContext);
             const [search, setSearch] = useState('');
             const todos = useMemo(() => {
                 const now = new Date(); const items = [];
                 reports.forEach(r => { if (r.nextContactDate && !r.completed) items.push({ type: 'report', date: new Date(`${r.nextContactDate}T${r.nextContactTime || '09:00'}`), data: r, label: 'Contatto', icon: Icons.Phone, collection: 'reports' }); });
                 followups.forEach(f => { if (f.feedbackDate && !f.completed) items.push({ type: 'offer', date: new Date(f.feedbackDate), data: f, label: 'Riscontro Offerta', icon: Icons.Target, collection: 'followups' }); });
                 ideas.forEach(i => { if (i.deadline && !i.completed) items.push({ type: 'idea', date: new Date(i.deadline), data: i, label: 'Scadenza Idea', icon: Icons.Lightbulb, collection: 'ideas' }); });
                 return items.sort((a, b) => a.date - b.date);
             }, [reports, followups, ideas]);

             const filteredTodos = useMemo(() => { 
                if (!search) return todos; 
                const sNorm = normalizeForSearch(search);
                return todos.filter(item => {
                    const clientNorm = normalizeForSearch(item.data.client);
                    const descNorm = (item.data.description || item.data.notes || item.data.text || item.data.futureNotes || '').toLowerCase();
                    return clientNorm.includes(sNorm) || descNorm.includes(search.toLowerCase()); 
                }); 
             }, [todos, search]);

             const handleItemClick = (item) => {
                 if (item.type === 'report') { setSelectedReport(item.data); setView('detail'); } 
                 else if (item.type === 'offer') { setFollowupForm(item.data); setView('createFollowup'); } 
                 else if (item.type === 'idea') { setIdeaForm(item.data); setView('createIdea'); }
             };
             const getStyle = (type, date) => {
                const isPast = date < new Date();
                if (type === 'report') return isPast ? 'bg-red-50 border-red-200 text-red-900' : 'bg-gray-50 border-red-200 text-gray-800';
                if (type === 'offer') return isPast ? 'bg-orange-50 border-orange-200 text-orange-900' : 'bg-yellow-50 border-yellow-200 text-yellow-900';
                if (type === 'idea') return isPast ? 'bg-red-100 border-red-300 text-red-900' : 'bg-red-50 border-red-200 text-red-900';
                return 'bg-white border-gray-200';
            };
            return (
                <div className="animate-fade-in pb-32">
                    <header className="mb-6 flex justify-between items-center"><h1 className="text-2xl font-bold text-gray-800">Da Fare</h1><div className="bg-gray-800 text-white text-xs font-bold px-3 py-1 rounded-full">{todos.length} Attività</div></header>
                    <div className="mb-4 relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div><input type="text" placeholder="Cerca attività..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" />{search && <button onClick={() => setSearch('')} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400"><Icons.X size={18} /></button>}</div>
                    {filteredTodos.length === 0 ? <div className="flex flex-col items-center justify-center py-12 text-gray-400"><div className="bg-gray-100 p-4 rounded-full mb-3"><Icons.CheckSquare size={32} /></div><p>Tutto fatto!</p></div> : 
                        <div className="space-y-3">{filteredTodos.map((item, idx) => (<div key={`${item.type}-${item.data.id}-${idx}`} onClick={() => handleItemClick(item)} className={`p-4 rounded-xl border cursor-pointer active:scale-[0.99] transition-transform relative overflow-hidden ${getStyle(item.type, item.date)}`}><div className="flex justify-between items-start z-10 relative"><div className="flex-1 min-w-0 pr-2"><div className="flex items-center gap-2 text-xs font-bold uppercase tracking-wider opacity-70 mb-1"><item.icon size={12} /> {item.label}</div><div className="font-bold text-lg truncate mb-1">{item.data.client}</div><div className="text-sm opacity-80 truncate">{item.type === 'report' ? (item.data.futureNotes || item.data.description) : (item.data.notes || item.data.text || item.data.description)}</div></div><div className="text-right shrink-0 flex flex-col items-end gap-2"><div><div className="text-xs font-bold opacity-60 uppercase mb-1">{item.date < new Date() ? 'Scaduto' : 'Scade il'}</div><div className="font-bold text-lg leading-none">{item.date.getDate()}</div><div className="text-xs font-bold uppercase">{item.date.toLocaleString('it-IT')}</div></div><button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion(item.collection, item.data.id, false); }} className="bg-red-500 text-white p-2 rounded-full shadow-md hover:bg-red-600 transition-colors z-20"><Icons.Check size={16} /></button></div></div></div>))}</div>
                    }
                </div>
            );
        };

        const CleanDuplicatesModal = ({ groups, onClose, onDelete }) => {
            const [selectedIds, setSelectedIds] = useState(() => {
                const initialSelection = new Set();
                groups.forEach(group => { 
                    const sorted = [...group].sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0)); 
                    for (let i = 1; i < sorted.length; i++) { 
                        initialSelection.add(`${sorted[i]._sourceCollection}|${sorted[i].id}`); 
                    } 
                });
                return initialSelection;
            });

            const toggleSelection = (key) => { 
                const newSelection = new Set(selectedIds); 
                if (newSelection.has(key)) { newSelection.delete(key); } else { newSelection.add(key); } 
                setSelectedIds(newSelection); 
            };

            const handleDelete = () => { 
                const itemsToDelete = Array.from(selectedIds).map(k => {
                    const [coll, id] = k.split('|');
                    return { collection: coll, id };
                });
                onDelete(itemsToDelete); 
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center">
                            <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Icons.Trash2 className="text-purple-600" /> Pulizia Duplicati</h2>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full"><Icons.X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-1 space-y-4">
                            <p className="text-sm text-gray-600 mb-2">Trovati <strong>{groups.length}</strong> gruppi di elementi duplicati.</p>
                            {groups.map((group, groupIdx) => (
                                <div key={groupIdx} className="border border-gray-200 rounded-xl overflow-hidden">
                                    <div className="bg-gray-50 p-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider border-b border-gray-200 flex justify-between">
                                        <span>{group[0].client || group[0].ragioneSociale}</span>
                                        <span className="text-blue-600">{group[0]._typeLabel}</span>
                                    </div>
                                    <div>
                                        {group.map((item) => {
                                            const itemKey = `${item._sourceCollection}|${item.id}`;
                                            return (
                                                <div key={item.id} className="flex items-center p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50">
                                                    <input type="checkbox" checked={selectedIds.has(itemKey)} onChange={() => toggleSelection(itemKey)} className="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mr-3"/>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-medium text-gray-800 truncate">
                                                            {item.category || item.offerNumber || item.text || item.pIva || 'Elemento'}
                                                        </div>
                                                        <div className="text-[10px] text-gray-400">
                                                            Creato: {new Date(item.createdAt || item.updatedAt || 0).toLocaleString('it-IT')}
                                                        </div>
                                                    </div>
                                                    {selectedIds.has(itemKey) ? (<span className="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded">Elimina</span>) : (<span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">Mantieni</span>)}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t border-gray-100 flex gap-3 bg-gray-50 rounded-b-2xl">
                            <button onClick={onClose} className="flex-1 py-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-50">Annulla</button>
                            <button onClick={handleDelete} disabled={selectedIds.size === 0} className="flex-1 py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg disabled:opacity-50 disabled:shadow-none hover:bg-purple-700 flex justify-center items-center gap-2">
                                <Icons.Trash2 size={18} /> Elimina ({selectedIds.size})
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportForm = () => {
            const { reportForm: initialData, saveReport, setView, clients } = useContext(CRMContext);
            const [formData, setFormData] = useState(initialData);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value, ...(name === 'client' ? {contactRef: ''} : {}) })); };
            const handleSubmit = (e) => { e.preventDefault(); saveReport(formData); };
            const selectedClientData = useMemo(() => clients.find(c => c.ragioneSociale === formData.client), [clients, formData.client]);
            const availableContacts = selectedClientData ? [selectedClientData.contact1, selectedClientData.contact2, selectedClientData.contact3, selectedClientData.contact4].filter(c => c?.nome) : [];

            const getDuration = (type) => {
                if (type === 'APPUNTAMENTO') return 60;
                if (type === 'TELEFONATA') return 15;
                if (type === 'PROMEMORIA') return 5;
                return 60;
            };

            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica' : 'Nuovo'} Report</h2>
                    <form onSubmit={handleSubmit} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <SectionContainer title="Dati" icon={Icons.FileText}>
                            <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                            {availableContacts.length > 0 && (<div><label className="block text-sm font-bold text-gray-700 mb-1">Referente</label><select name="contactRef" value={formData.contactRef} onChange={handleChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"><option value="">Nessuno spec.</option>{availableContacts.map((c, idx) => (<option key={idx} value={c.nome}>{c.nome} {c.mansione ? `(${c.mansione})` : ''}</option>))}</select></div>)}
                            <div className="grid grid-cols-2 gap-4"><Input label="Data" type="date" name="date" value={formData.date} onChange={handleChange} required /><TimeWheelPicker value={formData.hours} onChange={(val) => setFormData(prev => ({...prev, hours: val}))} /></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Categoria</label><select name="category" value={formData.category} onChange={handleChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"><option>MANTENIMENTO RAPPORTO</option><option>ORDINE</option><option>RICHIESTA DI OFFERTA</option><option>RISCONTRO OFFERTA</option><option>COMUNICAZIONE</option><option>INIZIO RAPPORTO FORNITURE</option><option>SOLLECITO INIZIO FORNITURA</option><option>APPUNTAMENTO</option><option>ALTRO</option></select></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Tipo</label><select name="contactType" value={formData.contactType} onChange={handleChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"><option>TELEFONICO</option><option>APPUNTAMENTO</option><option>VISITA</option><option>LINKEDIN</option><option>WHATSAPP</option><option>CANTIERE</option><option>ALTRO</option></select></div>
                            <TextArea label="Descrizione" name="description" value={formData.description} onChange={handleChange} enableVoice={true} />
                        </SectionContainer>
                        <SectionContainer title="Follow-up" icon={Icons.AlarmCheck}>
                            <div><label className="block text-sm font-bold text-gray-700 mb-2">Tipo Promemoria</label><div className="flex gap-2 mb-3">{['APPUNTAMENTO', 'PROMEMORIA', 'TELEFONATA'].map(type => (<button key={type} type="button" onClick={() => setFormData(p => ({ ...p, calendarEventType: type }))} className={`flex-1 py-3 text-xs font-bold rounded-lg border transition-all ${formData.calendarEventType === type ? 'bg-gray-600 text-white border-gray-600' : 'bg-white text-gray-600 border-gray-200'}`}>{type}</button>))}</div></div>
                            <TextArea label="Appunti Futuri" name="futureNotes" value={formData.futureNotes} onChange={handleChange} />
                            <div className="grid grid-cols-2 gap-4"><Input label="Data" type="date" name="nextContactDate" value={formData.nextContactDate} onChange={handleChange} /><Input label="Ora" type="time" name="nextContactTime" value={formData.nextContactTime} onChange={handleChange} /></div>
                            <CalendarButton title={`${formData.calendarEventType} - ${formData.client}`} details={formData.futureNotes} date={formData.nextContactDate} time={formData.nextContactTime} uid={formData.calendarUid} sequence={formData.calendarSequence} duration={getDuration(formData.calendarEventType)} />
                        </SectionContainer>
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView('dashboard')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-gray-600 text-white font-bold rounded-xl shadow-lg shadow-gray-200 flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const FollowupForm = () => {
            const { followupForm: initialData, saveFollowup, setView, clients, toggleTaskCompletion } = useContext(CRMContext);
            const [formData, setFormData] = useState(initialData);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const toggleComplete = async () => { if (formData.id) { await toggleTaskCompletion('followups', formData.id, formData.completed); setFormData(prev => ({ ...prev, completed: !prev.completed })); } };

            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica Offerta' : 'Nuova Offerta'}</h2>
                    {formData.id && (<button onClick={toggleComplete} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg mb-6 flex items-center justify-center gap-2 transition-all ${formData.completed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}>{formData.completed ? <><Icons.Check size={20}/> Completato</> : <><Icons.AlarmCheck size={20}/> Da Fare</>}</button>)}
                    <form onSubmit={(e) => { e.preventDefault(); saveFollowup(formData); }} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <SectionContainer title="Dettagli Offerta" icon={Icons.Target}>
                            <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                            <Input label="Numero Offerta" name="offerNumber" value={formData.offerNumber} onChange={handleChange} required placeholder="Es. OFF-2024/001" />
                            <Input label="Importo (€)" type="number" step="0.01" name="amount" value={formData.amount} onChange={handleChange} required placeholder="0.00" />
                            <Input label="Data Riscontro Atteso" type="date" name="feedbackDate" value={formData.feedbackDate} onChange={handleChange} required />
                            <TextArea label="Note / Oggetto" name="notes" value={formData.notes} onChange={handleChange} placeholder="Dettagli sull'offerta..." />
                            <CalendarButton title={`Riscontro Offerta - ${formData.client}`} details={`Importo: ${formData.amount} - ${formData.notes}`} date={formData.feedbackDate} uid={formData.calendarUid} sequence={formData.calendarSequence} />
                        </SectionContainer>
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView('followups')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const OrderForm = () => {
            const { orderForm: initialData, saveOrder, setView, clients, deleteItem } = useContext(CRMContext);
            const [formData, setFormData] = useState({
                ...initialData,
                createdAt: initialData.createdAt || new Date().toISOString()
            });
            const [orderDate, setOrderDate] = useState(formData.createdAt.split('T')[0]);

            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            
            const handleOrderDateChange = (e) => {
                const newDate = e.target.value;
                setOrderDate(newDate);
                const d = new Date(newDate);
                const now = new Date();
                d.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
                setFormData(prev => ({ ...prev, createdAt: d.toISOString() }));
            };

            const handleDelete = async (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                if(await deleteItem('orders', formData.id)) {
                     setView('ordersList'); 
                }
            };

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">{formData.id ? 'Modifica Ordine' : 'Nuovo Ordine'}</h2>
                        {formData.id && (
                            <button type="button" onClick={handleDelete} className="p-2 text-red-500 bg-red-50 rounded-full hover:bg-red-100 transition-colors">
                                <Icons.Trash2 size={20} />
                            </button>
                        )}
                    </div>
                    
                    <form onSubmit={(e) => { e.preventDefault(); saveOrder(formData); }} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <SectionContainer title="Dettagli Ordine" icon={Icons.ShoppingBag}>
                            <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                            <Input label="Data Ordine" type="date" name="orderDate" value={orderDate} onChange={handleOrderDateChange} required />
                            <Input label="NUMERO ORDINE" name="offerNumber" value={formData.offerNumber} onChange={handleChange} required placeholder="Es. ORD-2024/001" />
                            <Input label="Importo (€)" type="number" step="0.01" name="amount" value={formData.amount} onChange={handleChange} required placeholder="0.00" />
                            <Input label="Provvigione (€)" type="number" step="0.01" name="commission" value={formData.commission} onChange={handleChange} placeholder="0.00" />
                        </SectionContainer>
                        <div className="pt-2 flex gap-3">
                            <button type="button" onClick={() => setView('dashboard')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button>
                            <button type="submit" className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button>
                        </div>
                    </form>
                </div>
            );
        };

        const IdeaForm = () => {
            const { ideaForm: initialData, saveIdea, setView, clients, toggleTaskCompletion } = useContext(CRMContext);
            const [formData, setFormData] = useState(initialData);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const toggleComplete = async () => { if (formData.id) { await toggleTaskCompletion('ideas', formData.id, formData.completed); setFormData(prev => ({ ...prev, completed: !prev.completed })); } };

            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica Idea' : 'Nuova Idea'}</h2>
                    {formData.id && (<button onClick={toggleComplete} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg mb-6 flex items-center justify-center gap-2 transition-all ${formData.completed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}>{formData.completed ? <><Icons.Check size={20}/> Completato</> : <><Icons.AlarmCheck size={20}/> Da Fare</>}</button>)}
                    <form onSubmit={(e) => { e.preventDefault(); saveIdea(formData); }} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <SectionContainer title="Dettagli Progetto" icon={Icons.Lightbulb}>
                            <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                            <TextArea label="Descrizione Idea" name="text" value={formData.text} onChange={handleChange} placeholder="Descrivi la tua idea o progetto..." enableVoice={true} />
                            <Input label="Data Scadenza" type="date" name="deadline" value={formData.deadline} onChange={handleChange} required />
                            <CalendarButton title={`Idea: ${formData.client}`} details={formData.text} date={formData.deadline} duration={5} uid={formData.calendarUid} sequence={formData.calendarSequence} />
                        </SectionContainer>
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView('ideas')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const FollowupsList = () => {
            const { followups, toggleSort, sortOrder, setFollowupForm, setView, deleteItem, toggleTaskCompletion } = useContext(CRMContext);
            const [search, setSearch] = useState('');
            const sorted = useMemo(() => [...followups].sort((a,b) => sortOrder.followups === 'desc' ? new Date(b.feedbackDate) - new Date(a.feedbackDate) : new Date(a.feedbackDate) - new Date(b.feedbackDate)), [followups, sortOrder.followups]);
            
            const filtered = sorted.filter(i => {
                const sNorm = normalizeForSearch(search);
                const clientNorm = normalizeForSearch(i.client);
                const notesNorm = (i.notes || '').toLowerCase();
                return clientNorm.includes(sNorm) || notesNorm.includes(search.toLowerCase());
            });

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-gray-800">Offerte</h2><div className="flex gap-2"><button onClick={() => toggleSort('followups')} className="flex items-center gap-1 bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600"><Icons.ArrowUpDown size={14} /> {sortOrder.followups === 'desc' ? 'Recenti' : 'Vecchie'}</button><button onClick={() => { setFollowupForm({}); setView('createFollowup'); }} className="bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2"><Icons.Plus size={16} /> Nuova</button></div></div>
                    <div className="mb-4 relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div><input type="text" placeholder="Cerca offerta..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" /></div>
                    <div className="space-y-3">{filtered.length === 0 ? <div className="text-center py-8 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">Nessuna offerta.</div> : filtered.map(item => (<div key={item.id} onClick={() => { setFollowupForm(item); setView('createFollowup'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative cursor-pointer active:scale-[0.99] transition-transform"><div className="flex justify-between items-start mb-2"><h3 className="font-bold text-gray-800 text-lg">{item.client}</h3><div className="text-right"><div className="font-bold text-yellow-600">€ {item.amount}</div><div className="text-[10px] text-gray-400">{item.offerNumber}</div></div></div><div className="text-sm text-gray-700 mb-3 whitespace-pre-wrap">{item.notes}</div><div className="flex justify-between items-center border-t border-gray-50 pt-3"><span className={`text-xs font-bold px-2 py-1 rounded ${new Date(item.feedbackDate) < new Date() ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{new Date(item.feedbackDate).toLocaleDateString('it-IT')}</span><div className="flex gap-2"><button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion('followups', item.id, item.completed); }} className={`p-2 rounded-full text-white shadow-sm transition-colors ${item.completed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}><Icons.Check size={16} /></button><button onClick={(e) => { e.stopPropagation(); deleteItem('followups', item.id); }} className="p-1.5 text-red-500 bg-red-50 rounded-lg"><Icons.Trash2 size={16} /></button></div></div></div>))}</div>
                </div>
            );
        };

        const IdeasList = () => {
            const { ideas, toggleSort, sortOrder, setIdeaForm, setView, deleteItem, toggleTaskCompletion } = useContext(CRMContext);
            const [search, setSearch] = useState('');
            const sorted = useMemo(() => [...ideas].sort((a,b) => sortOrder.ideas === 'desc' ? new Date(b.deadline) - new Date(a.deadline) : new Date(a.deadline) - new Date(b.deadline)), [ideas, sortOrder.ideas]);
            
            const filtered = sorted.filter(i => {
                const sNorm = normalizeForSearch(search);
                const clientNorm = normalizeForSearch(i.client);
                const textNorm = (i.text || '').toLowerCase();
                return clientNorm.includes(sNorm) || textNorm.includes(search.toLowerCase());
            });

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-gray-800">Idee</h2><div className="flex gap-2"><button onClick={() => toggleSort('ideas')} className="flex items-center gap-1 bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600"><Icons.ArrowUpDown size={14} /> {sortOrder.ideas === 'desc' ? 'Recenti' : 'Vecchie'}</button><button onClick={() => { setIdeaForm({}); setView('createIdea'); }} className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2"><Icons.Plus size={16} /> Nuova</button></div></div>
                    <div className="mb-4 relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div><input type="text" placeholder="Cerca idea..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" /></div>
                    <div className="space-y-3">{filtered.length === 0 ? <div className="text-center py-8 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">Nessuna idea.</div> : filtered.map(item => (<div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative"><div className="flex justify-between items-start mb-2"><h3 className="font-bold text-gray-800 text-lg">{item.client}</h3>{item.deadline && <span className={`text-xs font-bold px-2 py-1 rounded ${new Date(item.deadline) < new Date() ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{new Date(item.deadline).toLocaleDateString('it-IT')}</span>}</div><div className="text-sm text-gray-700 mb-3 whitespace-pre-wrap">{item.text}</div><div className="flex justify-end gap-2 border-t border-gray-50 pt-3"><button onClick={() => toggleTaskCompletion('ideas', item.id, item.completed)} className={`p-2 rounded-full text-white shadow-sm transition-colors ${item.completed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}><Icons.Check size={16} /></button><button onClick={() => { setIdeaForm(item); setView('createIdea'); }} className="p-1.5 text-blue-600 bg-blue-50 rounded-lg"><Icons.Edit2 size={16} /></button><button onClick={() => deleteItem('ideas', item.id)} className="p-1.5 text-red-500 bg-red-50 rounded-lg"><Icons.Trash2 size={16} /></button></div></div>))}</div>
                </div>
            );
        };

        const ClientsList = () => {
            const { sortedClients, toggleSort, sortOrder, setClientForm, setView, setSelectedClient, reports } = useContext(CRMContext);
            const [search, setSearch] = useState('');
            
            const filtered = useMemo(() => {
                const sNorm = normalizeForSearch(search);
                return sortedClients.filter(c => 
                    normalizeForSearch(c.ragioneSociale).includes(sNorm)
                );
            }, [sortedClients, search]);
            
            const getAnagraficaStats = (c) => {
                const fields = ['pIva', 'telefono', 'email', 'sedeLegale', 'pec', 'sdiCode'];
                const filled = fields.filter(f => c[f] && c[f].toString().trim() !== '').length;
                const percentage = Math.round((filled / fields.length) * 100);
                return { isComplete: filled === fields.length, percentage };
            };

            const getClientStatus = (clientName) => {
                const clientReports = reports.filter(r => r.client === clientName);
                if (clientReports.length === 0) return { label: 'FREDDO', color: 'bg-blue-100 text-blue-700 border-blue-200' };
                
                const lastReport = clientReports.reduce((latest, current) => new Date(current.date) > new Date(latest.date) ? current : latest);
                const diffTime = new Date() - new Date(lastReport.date);
                const diffDays = diffTime / (1000 * 60 * 60 * 24);

                if (diffDays < 15) return { label: 'CALDO', color: 'bg-red-100 text-red-700 border-red-200' };
                if (diffDays <= 30) return { label: 'TIEPIDO', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' };
                return { label: 'FREDDO', color: 'bg-blue-100 text-blue-700 border-blue-200' };
            };

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-gray-800">Clienti</h2><div className="flex gap-2"><button onClick={() => toggleSort('clients')} className="flex items-center gap-1 bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600"><Icons.ArrowUpDown size={14} /> {sortOrder.clients === 'desc' ? 'Z-A' : 'A-Z'}</button><button onClick={() => { setClientForm({}); setView('createClient'); }} className="bg-gray-900 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><Icons.Plus size={14} /> Nuovo</button></div></div>
                    <div className="mb-4 relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div><input type="text" placeholder="Cerca..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" /></div>
                    <div className="space-y-3">{filtered.length === 0 ? <div className="text-center py-8 text-gray-400 border border-dashed rounded-xl">Nessun cliente.</div> : filtered.map(c => {
                        const status = getClientStatus(c.ragioneSociale);
                        const anagrafica = getAnagraficaStats(c);
                        return (
                            <div key={c.id} onClick={() => { setSelectedClient(c); setView('clientDetail'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform relative">
                                <div className="flex justify-between items-start">
                                    <h3 className="font-bold text-gray-800 text-lg pr-2">{c.ragioneSociale}</h3>
                                    <span className={`text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wide shrink-0 ${status.color}`}>{status.label}</span>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">{c.sedeOperativa || c.sedeLegale || 'Sede non spec.'}</div>
                                {anagrafica.isComplete ? (
                                    <div className="mt-2 inline-block bg-green-100 text-green-800 text-[10px] font-bold px-2 py-1 rounded border border-green-200 uppercase tracking-wide">✔ Anagrafica Completa</div>
                                ) : (
                                    <div className="mt-2 inline-block bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-1 rounded border border-yellow-200 uppercase tracking-wide">⚠ Anagrafica Incompleta ({anagrafica.percentage}%)</div>
                                )}
                            </div>
                        );
                    })}</div>
                </div>
            );
        };

        const ReportList = () => {
             const { reports, toggleSort, sortOrder, setReportForm, setView, setSelectedReport, formatDuration, toggleTaskCompletion } = useContext(CRMContext);
             const [search, setSearch] = useState('');
             const filtered = useMemo(() => {
                const sNorm = normalizeForSearch(search);
                return reports.filter(r => normalizeForSearch(r.client).includes(sNorm) || (r.description || '').toLowerCase().includes(search.toLowerCase()));
             }, [reports, search]);
             const sorted = useMemo(() => [...filtered].sort((a,b) => {
                 const dateA = new Date(a.date).getTime(); const dateB = new Date(b.date).getTime();
                 if (sortOrder.reports === 'desc') return dateB - dateA;
                 return dateA - dateB;
             }), [filtered, sortOrder.reports]);
             return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-gray-800">Storico</h2><div className="flex gap-2"><button onClick={() => toggleSort('reports')} className="flex items-center gap-1 bg-white border border-gray-200 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600"><Icons.ArrowUpDown size={14} /> {sortOrder.reports === 'desc' ? 'Recenti' : 'Vecchi'}</button><button onClick={() => { setReportForm({}); setView('create'); }} className="bg-gray-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><Icons.Plus size={14} /> Nuovo</button></div></div>
                     <div className="mb-4 relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icons.Search size={18} /></div><input type="text" placeholder="Cerca..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" /></div>
                    <div className="space-y-3">{sorted.map(r => (<div key={r.id} onClick={() => { setSelectedReport(r); setView('detail'); }} className={`p-4 rounded-xl border relative cursor-pointer active:scale-[0.99] transition-transform ${r.nextContactDate && !r.completed && new Date(r.nextContactDate) < new Date() ? 'bg-yellow-50 border-yellow-200' : 'bg-white border-gray-100'}`}><div className="flex justify-between"><h3 className="font-bold text-gray-800 truncate pr-4">{r.client}</h3><span className="font-bold text-gray-600 shrink-0">{formatDuration(r.hours)}</span></div><div className="text-sm text-gray-500 flex justify-between mt-1"><span>{r.category}</span><div className="flex items-center gap-2"><span className="text-xs">{new Date(r.date).toLocaleDateString('it-IT')}</span>{r.nextContactDate && (<button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion('reports', r.id, r.completed); }} className={`p-1.5 rounded-full text-white shadow-sm transition-colors ${r.completed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}><Icons.Check size={12} /></button>)}</div></div></div>))}</div>
                </div>
             );
        };

        const ReportDetailView = () => {
            const { selectedReport, setView, setReportForm, deleteItem, formatDuration, toggleTaskCompletion, reports } = useContext(CRMContext);
            const report = useMemo(() => reports.find(r => r.id === selectedReport?.id) || selectedReport, [reports, selectedReport]);
            if (!report) return null;
            return (
                <div className="animate-fade-in pb-32">
                     <div className="flex justify-between items-center mb-6"><button onClick={() => setView('list')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button><div className="flex gap-2"><button onClick={() => { setReportForm(report); setView('create'); }} className="p-2 text-blue-600 bg-blue-50 rounded-full hover:bg-blue-100"><Icons.Edit2 size={20} /></button><button onClick={async () => { if (await deleteItem('reports', report.id)) setView('list'); }} className="p-2 text-red-500 bg-red-50 rounded-full hover:bg-red-100"><Icons.Trash2 size={20} /></button></div></div>
                    {report.nextContactDate && (<button onClick={() => toggleTaskCompletion('reports', report.id, report.completed)} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg mb-6 flex items-center justify-center gap-2 transition-all ${report.completed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}`}>{report.completed ? <><Icons.Check size={20}/> Completato</> : <><Icons.AlarmCheck size={20}/> Da Fare</>}</button>)}
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                        <div><h1 className="text-xl font-bold text-gray-800">{report.title}</h1><p className="text-sm text-gray-500">{new Date(report.date).toLocaleDateString('it-IT')} - {formatDuration(report.hours)}</p></div>
                        <InfoBox label="Cliente" value={report.client} icon={Icons.Users} /><InfoBox label="Categoria" value={report.category} icon={Icons.Target} /><InfoBox label="Tipo Contatto" value={report.contactType} icon={Icons.Phone} /><SectionDisplay title="Descrizione" content={report.description} />
                        {report.futureNotes && (<div className="bg-yellow-50 p-4 rounded-xl border border-yellow-100"><h3 className="text-sm font-bold text-yellow-800 mb-2 flex items-center gap-2"><Icons.Bell size={16}/> Appunti Futuri</h3><p className="text-sm text-yellow-900">{report.futureNotes}</p></div>)}
                    </div>
                </div>
            );
        };
        
        const ClientReportsView = () => {
            const { selectedClient, reports, setView, setSelectedReport, formatDuration } = useContext(CRMContext);
            const clientReports = useMemo(() => reports.filter(r => r.client === selectedClient?.ragioneSociale).sort((a,b) => new Date(b.date) - new Date(a.date)), [reports, selectedClient]);
            return (
                <div className="animate-fade-in pb-32">
                    <div className="sticky top-0 bg-gray-100/95 backdrop-blur z-10 p-4 mb-4 flex items-center border-b border-gray-200"><button onClick={() => setView('clientDetail')} className="p-2 -ml-2 rounded-full hover:bg-gray-200 mr-2"><Icons.ChevronRight size={24} className="rotate-180" /></button><div><h1 className="text-xl font-bold text-gray-800">Report Cliente</h1><div className="text-xs text-gray-500">{selectedClient?.ragioneSociale}</div></div></div>
                    <div className="space-y-3 px-4 pt-0">{clientReports.length === 0 ? <div className="text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed">Nessun report.</div> : clientReports.map(r => (<div key={r.id} onClick={() => { setSelectedReport(r); setView('detail'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative cursor-pointer active:scale-[0.99] transition-transform"><div className="flex justify-between"><h3 className="font-bold text-gray-800 truncate pr-4">{r.category}</h3><span className="font-bold text-gray-600 shrink-0">{formatDuration(r.hours)}</span></div><div className="text-sm text-gray-500 flex justify-between mt-1"><span>{new Date(r.date).toLocaleDateString('it-IT')}</span></div></div>))}</div>
                </div>
            );
        };

        const ClientOrdersView = () => {
            const { selectedClient, orders, setView, setOrderForm } = useContext(CRMContext);
            const clientOrders = useMemo(() => orders.filter(o => o.client === selectedClient?.ragioneSociale).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)), [orders, selectedClient]);
            return (
                <div className="animate-fade-in pb-32">
                    <div className="sticky top-0 bg-gray-100/95 backdrop-blur z-10 p-4 mb-4 flex items-center border-b border-gray-200"><button onClick={() => setView('clientDetail')} className="p-2 -ml-2 rounded-full hover:bg-gray-200 mr-2"><Icons.ChevronRight size={24} className="rotate-180" /></button><div><h1 className="text-xl font-bold text-gray-800">Storico Ordini</h1><div className="text-xs text-gray-500">{selectedClient?.ragioneSociale}</div></div></div>
                    <div className="space-y-3 px-4 pt-0">{clientOrders.length === 0 ? <div className="text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed">Nessun ordine.</div> : clientOrders.map(o => (<div key={o.id} onClick={() => { setOrderForm(o); setView('createOrder'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative cursor-pointer active:scale-[0.99] transition-transform"><div className="flex justify-between items-start"><div className="font-bold text-gray-800">€ {o.amount}</div><div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">{o.offerNumber}</div></div></div>))}</div>
                </div>
            );
        };

        const ClientDetailView = () => {
            const { selectedClient, setView, setClientForm, setReportForm, setFollowupForm, setIdeaForm, setOrderForm, deleteItem, orders } = useContext(CRMContext);
            if (!selectedClient) return null;
            const { totalOrders, totalCommissions } = useMemo(() => orders.filter(o => o.client === selectedClient.ragioneSociale).reduce((acc, curr) => ({ totalOrders: acc.totalOrders + (parseFloat(curr.amount) || 0), totalCommissions: acc.totalCommissions + (parseFloat(curr.commission) || 0) }), { totalOrders: 0, totalCommissions: 0 }), [orders, selectedClient]);
            return (
                <div className="animate-fade-in pb-32 bg-gray-100 min-h-full">
                    <div className="sticky top-0 bg-gray-100/95 backdrop-blur z-10 p-4 mb-2 flex justify-between items-center border-b border-gray-200"><button onClick={() => setView('clients')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button><div className="flex gap-2"><button onClick={() => { setClientForm(selectedClient); setView('createClient'); }} className="p-2 text-blue-600 bg-blue-50 rounded-full hover:bg-blue-100"><Icons.Edit2 size={20}/></button><button onClick={async () => { if (await deleteItem('clients', selectedClient.id)) setView('clients'); }} className="p-2 text-red-500 bg-red-50 rounded-full hover:bg-red-100"><Icons.Trash2 size={20}/></button></div></div>
                    <div className="px-4 space-y-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h1 className="text-2xl font-bold text-gray-900 leading-tight mb-1">{selectedClient.ragioneSociale}</h1><p className="text-sm text-gray-500">P.IVA: {selectedClient.pIva || '-'}</p><div className="mt-4 pt-4 border-t border-gray-100 grid grid-cols-2 gap-4"><div><div className="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Totale Ordini</div><div className="text-lg font-bold text-blue-600">€ {totalOrders.toFixed(2)}</div></div><div><div className="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Totale Provvigioni</div><div className="text-lg font-bold text-green-600">€ {totalCommissions.toFixed(2)}</div></div></div></div>
                        <div className="grid grid-cols-2 gap-3"><button onClick={() => { setReportForm({ client: selectedClient.ragioneSociale, date: new Date().toISOString().split('T')[0], category: 'MANTENIMENTO RAPPORTO' }); setView('create'); }} className="flex flex-col items-center p-4 bg-white border border-gray-100 rounded-2xl shadow-sm"><Icons.FileText size={20} className="text-blue-600" /><span className="text-xs font-bold mt-1">Nuovo Report</span></button><button onClick={() => setView('clientReports')} className="flex flex-col items-center p-4 bg-white border border-gray-100 rounded-2xl shadow-sm"><Icons.ClipboardList size={20} /><span className="text-xs font-bold mt-1">Storico Report</span></button></div>
                    </div>
                </div>
            );
        };

        const ClientForm = () => {
            const { clientForm: initialData, saveClient, setView } = useContext(CRMContext);
            const [formData, setFormData] = useState({ contact1: {}, ...initialData });
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));
            return (
                <div className="animate-fade-in pb-32 bg-gray-100 min-h-full">
                    <div className="sticky top-0 bg-white z-10 p-4 border-b border-gray-200 flex justify-between shadow-sm"><button onClick={() => setView('clients')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button><button onClick={() => saveClient(formData)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2"><Icons.Save size={16} /> Salva</button></div>
                    <div className="p-4 space-y-6"><SectionContainer title="Anagrafica" icon={Icons.Building2}><Input label="Ragione Sociale *" name="ragioneSociale" value={formData.ragioneSociale} onChange={handleChange} required /><Input label="Partita IVA" name="pIva" value={formData.pIva} onChange={handleChange} /></SectionContainer></div>
                </div>
            );
        };

        const StatsView = () => {
            const { reports, orders } = useContext(CRMContext);
            const stats = useMemo(() => {
                const map = {};
                reports.forEach(r => { if(!map[r.client]) map[r.client] = { name: r.client, orders: 0, hours: 0 }; map[r.client].hours += parseFloat(r.hours)||0; });
                orders.forEach(o => { if(!map[o.client]) map[o.client] = { name: o.client, orders: 0, hours: 0 }; map[o.client].orders += parseFloat(o.amount)||0; });
                return Object.values(map).sort((a,b) => b.orders - a.orders);
            }, [reports, orders]);
            return (
                <div className="animate-fade-in pb-32">
                    <h1 className="text-2xl font-bold mb-6">Situazione</h1>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">{stats.map(s => (<div key={s.name} className="border-b last:border-0 pb-3"><div className="font-bold text-gray-800">{s.name}</div><div className="flex justify-between text-xs text-gray-500"><span>Ordini: €{s.orders.toFixed(0)}</span><span>Ore: {s.hours.toFixed(1)}h</span></div></div>))}</div>
                </div>
            );
        };

        const OrdersListView = () => {
            const { orders, setView, setOrderForm } = useContext(CRMContext);
            return (
                <div className="animate-fade-in pb-32">
                    <div className="sticky top-0 bg-white/95 backdrop-blur z-10 p-4 mb-4 flex items-center justify-between border-b border-gray-200"><div className="flex items-center"><button onClick={() => setView('dashboard')} className="p-2 -ml-2 rounded-full hover:bg-gray-200 mr-2"><Icons.ChevronRight size={24} className="rotate-180" /></button><h1 className="text-xl font-bold text-gray-800">Tutti gli Ordini</h1></div><button onClick={() => { setOrderForm({}); setView('createOrder'); }} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><Icons.Plus size={16} /> Nuovo</button></div>
                    <div className="space-y-3 px-4">{orders.map(o => (<div key={o.id} onClick={() => { setOrderForm(o); setView('createOrder'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer"><div className="flex justify-between"><div className="font-bold text-gray-800">{o.client}</div><div className="font-bold text-blue-600">€ {o.amount}</div></div><div className="text-xs text-gray-400 mt-1">{o.offerNumber} - {new Date(o.createdAt).toLocaleDateString('it-IT')}</div></div>))}</div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [userKey, setUserKey] = useState(localStorage.getItem('crm_user_key') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(!!userKey);
            const [view, setView] = useState('dashboard');
            const [clients, setClients] = useState([]);
            const [reports, setReports] = useState([]);
            const [followups, setFollowups] = useState([]);
            const [ideas, setIdeas] = useState([]);
            const [orders, setOrders] = useState([]); 
            const [selectedReport, setSelectedReport] = useState(null);
            const [selectedClient, setSelectedClient] = useState(null);
            const [reportForm, setReportForm] = useState({});
            const [clientForm, setClientForm] = useState({});
            const [followupForm, setFollowupForm] = useState({});
            const [ideaForm, setIdeaForm] = useState({});
            const [orderForm, setOrderForm] = useState({}); 
            const [sortOrder, setSortOrder] = useState({ reports: 'desc', clients: 'asc', followups: 'desc', ideas: 'desc' });
            const [message, showMessageState] = useState({ text: '', type: '' });
            const [showCleanModal, setShowCleanModal] = useState(false);
            const [duplicatesData, setDuplicatesData] = useState([]);
            const fileInputRef = useRef(null);

            const showMessage = (text, type='info') => { showMessageState({text, type}); setTimeout(() => showMessageState({text:'', type:''}), 3000); };
            
            useEffect(() => { const app = initializeApp(firebaseConfig); const auth = getAuth(app); const dbInst = getFirestore(app); setDb(dbInst); onAuthStateChanged(auth, u => !u && signInAnonymously(auth)); }, []);
            useEffect(() => {
                if (!db || !userKey) return;
                const key = userKey.toLowerCase().replace(/\s/g, '');
                const subs = [ 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/reports`), s => setReports(s.docs.map(d => ({ ...d.data(), id: d.id })))), 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/clients`), s => setClients(s.docs.map(d => ({ ...d.data(), id: d.id })))), 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/followups`), s => setFollowups(s.docs.map(d => ({ ...d.data(), id: d.id })))), 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/ideas`), s => setIdeas(s.docs.map(d => ({ ...d.data(), id: d.id })))),
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/orders`), s => setOrders(s.docs.map(d => ({ ...d.data(), id: d.id }))))
                ];
                return () => subs.forEach(unsub => unsub());
            }, [db, userKey]);

            const handleCleanDuplicates = () => {
                const allGroups = [];
                const collections = [
                    { data: reports, coll: 'reports', label: 'REPORT', keyFn: r => `${normalizeForSearch(r.client)}|${r.date}|${normalizeForSearch(r.category)}|${normalizeForSearch(r.description)}` },
                    { data: orders, coll: 'orders', label: 'ORDINE', keyFn: o => `${normalizeForSearch(o.client)}|${normalizeForSearch(o.offerNumber)}|${o.amount}` },
                    { data: followups, coll: 'followups', label: 'OFFERTA', keyFn: f => `${normalizeForSearch(f.client)}|${normalizeForSearch(f.offerNumber)}|${f.amount}` },
                    { data: ideas, coll: 'ideas', label: 'IDEA', keyFn: i => `${normalizeForSearch(i.client)}|${normalizeForSearch(i.text)}` },
                    { data: clients, coll: 'clients', label: 'CLIENTE', keyFn: c => `${normalizeForSearch(c.ragioneSociale)}` }
                ];

                collections.forEach(({ data, coll, label, keyFn }) => {
                    const groups = {};
                    data.forEach(item => {
                        const key = keyFn(item);
                        if (!groups[key]) groups[key] = [];
                        groups[key].push({ ...item, _sourceCollection: coll, _typeLabel: label });
                    });
                    Object.values(groups).forEach(g => { if (g.length > 1) allGroups.push(g); });
                });

                if (allGroups.length === 0) { showMessage('Nessun duplicato trovato.', 'info'); return; }
                setDuplicatesData(allGroups);
                setShowCleanModal(true);
            };

            const executeClean = async (itemsToDelete) => {
                if (itemsToDelete.length === 0) return;
                const key = userKey.toLowerCase().replace(/\s/g, '');
                try {
                    const deletePromises = itemsToDelete.map(item => deleteDoc(doc(db, `artifacts/${appId}/users/${key}/${item.collection}`, item.id)));
                    await Promise.all(deletePromises);
                    showMessage(`Eliminati ${itemsToDelete.length} duplicati.`, 'success');
                    setShowCleanModal(false);
                } catch (error) {
                    showMessage('Errore durante l\'eliminazione.', 'error');
                }
            };

            const saveItem = async (coll, data) => { const key = userKey.toLowerCase().replace(/\s/g, ''); const id = data.id || String(Date.now()); await setDoc(doc(db, `artifacts/${appId}/users/${key}/${coll}`, id), { ...data, id, createdAt: data.createdAt || new Date().toISOString() }); showMessage('Salvato!', 'success'); };

            const contextValue = { 
                db, userKey, view, setView, clients, reports, followups, ideas, orders,
                sortedClients: clients, sortOrder, toggleSort: (k) => setSortOrder(p => ({ ...p, [k]: p[k] === 'desc' ? 'asc' : 'desc' })),
                selectedReport, setSelectedReport, selectedClient, setSelectedClient, 
                reportForm, setReportForm, clientForm, setClientForm, followupForm, setFollowupForm, ideaForm, setIdeaForm, orderForm, setOrderForm,
                saveReport: d => { saveItem('reports', d); setView('list'); }, saveClient: d => { saveItem('clients', d); setView('clients'); }, saveFollowup: d => { saveItem('followups', d); setView('followups'); }, saveIdea: d => { saveItem('ideas', d); setView('ideas'); }, saveOrder: d => { saveItem('orders', d); setView('ordersList'); },
                deleteItem: async (coll, id) => { if (window.confirm("Eliminare?")) { const key = userKey.toLowerCase().replace(/\s/g, ''); await deleteDoc(doc(db, `artifacts/${appId}/users/${key}/${coll}`, id)); return true; } return false; },
                toggleTaskCompletion: async (coll, id, st) => { const key = userKey.toLowerCase().replace(/\s/g, ''); await setDoc(doc(db, `artifacts/${appId}/users/${key}/${coll}`, id), { completed: !st }, { merge: true }); },
                fileInputRef, exportToExcel: () => showMessage('Export...'), handleCleanDuplicates, handleLogout: () => { localStorage.removeItem('crm_user_key'); setUserKey(''); setIsLoggedIn(false); }, formatDuration: d => d+'h'
            };

            if (!isLoggedIn) return ( <div className="min-h-screen bg-gray-100 flex justify-center items-center p-4"> <form onSubmit={(e) => { e.preventDefault(); const val = e.target.elements[0].value.trim(); if(val) { localStorage.setItem('crm_user_key', val); setUserKey(val); setIsLoggedIn(true); } }} className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center"> <div className="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icons.Lock size={32}/></div> <h1 className="text-2xl font-bold mb-2">WorkReport CRM</h1> <input type="text" placeholder="Tua Chiave Segreta" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center font-bold outline-none border focus:border-blue-500" autoFocus/> <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Accedi</button> </form> </div> );

            return (
                <CRMContext.Provider value={contextValue}>
                    <div className="min-h-screen bg-gray-100 flex justify-center pt-0 sm:pt-6">
                        <div className="w-full max-w-7xl bg-gray-100 h-dvh sm:rounded-[2.5rem] sm:shadow-2xl overflow-hidden flex flex-col ring-8 ring-gray-900/5">
                            <div className="flex-1 overflow-y-auto p-6">
                                {view === 'dashboard' && <DashboardView />}
                                {view === 'todo' && <TodoView />}
                                {view === 'list' && <ReportList />}
                                {view === 'create' && <ReportForm />}
                                {view === 'clients' && <ClientsList />}
                                {view === 'createClient' && <ClientForm />}
                                {view === 'clientDetail' && <ClientDetailView />}
                                {view === 'clientReports' && <ClientReportsView />}
                                {view === 'clientOrders' && <ClientOrdersView />}
                                {view === 'ordersList' && <OrdersListView />}
                                {view === 'detail' && <ReportDetailView />}
                                {view === 'followups' && <FollowupsList />}
                                {view === 'createFollowup' && <FollowupForm />}
                                {view === 'createOrder' && <OrderForm />}
                                {view === 'ideas' && <IdeasList />}
                                {view === 'createIdea' && <IdeaForm />}
                                {view === 'stats' && <StatsView />}
                                {view === 'manual' && <ManualView />}
                            </div>
                            <nav className="border-t border-gray-200 p-3 bg-white flex justify-around">
                                {[{ id: 'dashboard', icon: Icons.LayoutDashboard, label: 'Home' }, { id: 'todo', icon: Icons.CheckSquare, label: 'TO-DO' }, { id: 'stats', icon: Icons.BarChart, label: 'Situazione' }, { id: 'clients', icon: Icons.Users, label: 'Clienti' }].map(item => (<button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center p-2 transition-all ${view === item.id ? 'text-blue-600' : 'text-gray-400'}`}><item.icon size={24} /><span className="text-[10px] font-bold">{item.label}</span></button>))}
                            </nav>
                            {message.text && (<div className="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-xl text-white font-bold text-sm z-50 bg-blue-500">{message.text}</div>)}
                            {showCleanModal && (<CleanDuplicatesModal groups={duplicatesData} onClose={() => setShowCleanModal(false)} onDelete={executeClean} />)}
                        </div>
                    </div>
                </CRMContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
