<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CRM WorkReport v1.0</title>
    
    <!-- 1. Stile Grafico (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Motore dell'App (React) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Traduttore Codice (Babel) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <!-- 4. Libreria per Export Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .h-dvh { height: 100dvh; }
        input, textarea, select { font-size: 16px !important; }

        .wheel-scroller {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .wheel-scroller::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURAZIONE
        const appId = "miocrm-0001";
        const firebaseConfig = {
            apiKey: "AIzaSyAjP1UXwDJqAhWVjpb6ePrgtv3nQJ7fWFk",
            authDomain: "miocrm-0001.firebaseapp.com",
            projectId: "miocrm-0001",
            storageBucket: "miocrm-0001.firebasestorage.app",
            messagingSenderId: "880667208118",
            appId: "1:880667208118:web:d1d420b2d7d1743fde7917"
        };

        const { useState, useEffect, useMemo, useRef, useContext, createContext, useCallback } = React;

        // --- UTILS ---
        const normalizeForSearch = (str) => (str || '').toLowerCase().replace(/[^a-z0-9]/g, '');

        // --- CONTEXT ---
        const CRMContext = createContext();

        // --- ICONS ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        
        const Icons = {
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            LayoutDashboard: (p) => <IconBase {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            Lightbulb: (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5a6 6 0 0 0-11 0c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            ChevronRight: (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>,
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            Building2: (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            Check: (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>,
            ArrowUpDown: (p) => <IconBase {...p}><path d="m21 16-4 4-4-4"/><path d="m17 20V4"/><path d="m3 8 4-4 4 4"/><path d="m7 4v16"/></IconBase>,
            ClipboardList: (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>,
            BarChart: (p) => <IconBase {...p}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></IconBase>,
            CheckSquare: (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h11"/></IconBase>,
            BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
            Mic: (p) => <IconBase {...p}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></IconBase>,
            ShoppingBag: (p) => <IconBase {...p}><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" x2="21" y1="6" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Phone: (p) => <IconBase {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>
        };

        // --- UI COMPONENTS ---
        const InfoBox = ({ label, value, icon: Icon, color = 'text-gray-700' }) => (
            <div className="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1 mb-1">{Icon && <Icon size={12} className={color} />} {label}</div>
                <div className={`text-lg font-semibold ${color}`}>{value || '-'}</div>
            </div>
        );

        const InfoRow = ({ label, value }) => {
            if (!value) return null; 
            return (
                <div className="border-b border-gray-50 pb-2 last:border-0">
                    <div className="text-xs text-gray-500 mb-1 uppercase tracking-wide">{label}</div>
                    <div className="text-sm font-semibold text-gray-800 break-words whitespace-normal">{value}</div>
                </div>
            );
        };

        const Input = ({ label, name, value, onChange, type = 'text', required = false, step = null, placeholder = '', list = null }) => (
            <div>
                {label && <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>}
                <input type={type} name={name} value={value ?? ''} onChange={onChange} required={required} step={step} placeholder={placeholder} list={list}
                    className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" />
            </div>
        );

        const TextArea = ({ label, name, value, onChange, placeholder = '', enableVoice = false }) => {
            const [isListening, setIsListening] = useState(false);
            const handleVoice = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("Riconoscimento vocale non supportato."); return; }
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'it-IT';
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const newValue = value ? `${value} ${transcript}` : transcript;
                    onChange({ target: { name, value: newValue } });
                };
                recognition.start();
            };
            return (
                <div className="relative">
                    <div className="flex justify-between items-center mb-1">
                        <label className="block text-sm font-bold text-gray-700">{label}</label>
                        {enableVoice && (
                            <button type="button" onClick={handleVoice} className={`p-1 rounded-full transition-colors ${isListening ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                                <Icons.Mic size={14} />
                            </button>
                        )}
                    </div>
                    <textarea name={name} value={value ?? ''} onChange={onChange} placeholder={placeholder} rows="3" 
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none transition-shadow" />
                </div>
            );
        };
        
        const SelectComponent = ({ label, name, value, onChange, options }) => {
            const safeValue = (typeof value === 'string' || typeof value === 'number') ? value : '';
            return (
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>
                    <select name={name} value={safeValue} onChange={onChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleziona...</option>
                        {options.map(option => (<option key={option} value={option}>{option}</option>))}
                    </select>
                </div>
            );
        };

        const MultiSelect = ({ label, name, value, onChange, options, height = "max-h-40" }) => {
            const selected = (typeof value === 'string' && value.length > 0) ? value.split(', ') : [];
            const toggle = (opt) => {
                const newSel = selected.includes(opt) ? selected.filter(s => s !== opt) : [...selected, opt];
                onChange({ target: { name, value: newSel.join(', ') } });
            };
            return (
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>
                    <div className={`bg-gray-50 border border-gray-200 rounded-xl p-2 ${height} overflow-y-auto`}>
                        {options.map(opt => (
                            <div key={opt} onClick={() => toggle(opt)} className="flex items-center gap-2 p-2 hover:bg-gray-100 rounded cursor-pointer">
                                <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${selected.includes(opt) ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}>
                                    {selected.includes(opt) && <Icons.Check size={14} className="text-white" />}
                                </div>
                                <span className="text-sm text-gray-700">{opt}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ClientSearchInput = ({ clients, value, onChange, required = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const sortedClients = useMemo(() => [...clients].sort((a, b) => (a.ragioneSociale || '').localeCompare(b.ragioneSociale || '')), [clients]);
            const filteredOptions = sortedClients.filter(c => normalizeForSearch(c.ragioneSociale).includes(normalizeForSearch(value)));
            return (
                <div className="relative">
                    <label className="block text-sm font-bold text-gray-700 mb-1">Cliente {required && '*'}</label>
                    <input type="text" name="client" value={value || ''} onChange={(e) => { onChange(e); setIsOpen(true); }} onFocus={() => setIsOpen(true)} onBlur={() => setTimeout(() => setIsOpen(false), 200)} required={required} placeholder="Cerca cliente..." autoComplete="off"
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" />
                    {isOpen && filteredOptions.length > 0 && (
                        <div className="absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto">
                            {filteredOptions.map(c => (<div key={c.id} onClick={() => { onChange({ target: { name: 'client', value: c.ragioneSociale } }); setIsOpen(false); }} className="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 text-sm">{c.ragioneSociale}</div>))}
                        </div>
                    )}
                </div>
            );
        };

        const TimeWheelPicker = ({ value, onChange }) => {
            const hVal = Math.floor(parseFloat(value) || 0);
            const mVal = Math.round(((parseFloat(value) || 0) - hVal) * 60);
            const hours = [...Array(13).keys()]; 
            const minutes = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
            const itemHeight = 40;
            const hRef = useRef(null);
            const mRef = useRef(null);
            const handleScroll = (e, type) => {
                const index = Math.round(e.target.scrollTop / itemHeight);
                if (type === 'h') updateTime(hours[index] ?? hVal, mVal);
                else updateTime(hVal, minutes[index] ?? mVal);
            };
            const updateTime = (h, m) => {
                const decimal = (h + (m / 60)).toFixed(2);
                onChange(parseFloat(decimal).toString());
            };
            useEffect(() => {
                if(hRef.current) hRef.current.scrollTop = hours.indexOf(hVal) * itemHeight;
                if(mRef.current) mRef.current.scrollTop = minutes.indexOf(mVal) * itemHeight;
            }, []);
            return (
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">Durata</label>
                    <div className="flex justify-center gap-2 py-4 relative bg-gray-50 rounded-xl border border-gray-200">
                        <div className="absolute top-1/2 -translate-y-1/2 w-full h-[40px] bg-blue-100/50 pointer-events-none border-y border-blue-200"></div>
                        <div className="w-24 h-[120px] overflow-y-auto snap-y snap-mandatory wheel-scroller relative z-10 text-center" onScroll={(e) => handleScroll(e, 'h')} ref={hRef}>
                            <div className="h-10"/>{hours.map(h => (<div key={h} className="h-10 flex items-center justify-center font-bold text-gray-700 snap-center">{h}h</div>))}<div className="h-10"/>
                        </div>
                        <div className="w-24 h-[120px] overflow-y-auto snap-y snap-mandatory wheel-scroller relative z-10 text-center" onScroll={(e) => handleScroll(e, 'm')} ref={mRef}>
                            <div className="h-10"/>{minutes.map(m => (<div key={m} className="h-10 flex items-center justify-center font-bold text-gray-700 snap-center">{m}m</div>))}<div className="h-10"/>
                        </div>
                    </div>
                </div>
            );
        };

        const SectionContainer = ({ title, icon: Icon, children }) => {
            const validChildren = React.Children.toArray(children).filter(child => child); 
            if (validChildren.length === 0) return null;
            return (
                <section className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                    <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">{Icon && <Icon size={14} />} {title}</h3>
                    {children}
                </section>
            );
        };
        
        const SectionDisplay = ({ title, content, small = false }) => {
            if (!content) return null;
            return (
                <div className="space-y-1">
                    <h3 className={`font-bold ${small ? 'text-xs uppercase text-gray-400' : 'text-sm text-gray-700'}`}>{title}</h3>
                    <p className={`whitespace-pre-wrap text-sm text-gray-800 p-3 bg-gray-50 rounded-lg border border-gray-100`}>{content}</p>
                </div>
            );
        };

        const CalendarButton = ({ title, details, date, time = "09:00", duration = 60, uid, sequence = 0 }) => {
            if (!date) return null;
            const start = new Date(`${date}T${time}`);
            const end = new Date(start.getTime() + duration * 60000);
            const openGoogle = () => {
                const dates = `${start.toISOString().replace(/-|:|\.\d{3}/g, '')}/${end.toISOString().replace(/-|:|\.\d{3}/g, '')}`;
                window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(details)}&dates=${dates}`, '_blank');
            };
            return (
                <button type="button" onClick={openGoogle} className="w-full flex justify-center items-center gap-2 px-3 py-3 bg-indigo-50 text-indigo-600 font-bold rounded-xl border border-indigo-100 active:scale-[0.98] transition-all text-xs">
                    <Icons.Calendar size={16} /> Aggiungi a Google Calendar
                </button>
            );
        };

        // --- NEW CHART COMPONENT UPDATED ---
        const MonthChart = ({ data }) => {
            const max = Math.max(...data.map(d => d.value), 1);
            return (
                <div className="flex items-end gap-3 h-32 mt-4 mb-6 px-2 overflow-x-auto scrollbar-hide border-b border-gray-100 pb-4">
                    {data.map((d, i) => (
                        <div key={i} className="flex flex-col items-center min-w-[40px] h-full justify-end group">
                            <div className="flex-1 w-full flex items-end justify-center mb-1">
                                <div 
                                    className="w-4 bg-blue-500 rounded-t-md opacity-80 group-hover:opacity-100 transition-all" 
                                    style={{ height: `${(d.value / max) * 100}%`, minHeight: '4px' }}
                                ></div>
                            </div>
                            <div className="text-[10px] font-bold text-gray-800">€{Math.round(d.value)}</div>
                            <div className="text-[9px] text-gray-400 uppercase font-bold mt-0.5">{d.label}</div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- CLEAN DUPLICATES MODAL ---
        const CleanDuplicatesModal = ({ groups, onClose, onDelete }) => {
            const [selectedIds, setSelectedIds] = useState(new Set());
            const toggleSelection = (key) => {
                const newSet = new Set(selectedIds);
                if (newSet.has(key)) newSet.delete(key); else newSet.add(key);
                setSelectedIds(newSet);
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b flex justify-between items-center"><h2 className="text-lg font-bold">Pulizia Duplicati</h2><button onClick={onClose}><Icons.X size={24}/></button></div>
                        <div className="p-4 overflow-y-auto flex-1 space-y-4">
                            {groups.map((group, gidx) => (
                                <div key={gidx} className="border rounded-xl p-2 space-y-2">
                                    <div className="text-xs font-bold text-gray-400 uppercase">{group[0].client || group[0].ragioneSociale} <span className="text-gray-300">({group[0]._sourceCollection})</span></div>
                                    {group.map(item => (
                                        <div key={item.id} className="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                                            <input type="checkbox" onChange={() => toggleSelection(`${item._sourceCollection}|${item.id}`)} className="w-5 h-5 accent-red-600" />
                                            <div className="text-sm truncate flex-1">{item._displayLabel || item.category || item.offerNumber || 'Dettaglio'}</div>
                                            <div className="text-xs text-gray-400">{new Date(item.createdAt || item.date).toLocaleDateString()}</div>
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t flex gap-3"><button onClick={onClose} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold">Annulla</button><button onClick={() => onDelete(Array.from(selectedIds).map(k => ({collection: k.split('|')[0], id: k.split('|')[1]})))} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold">Elimina Selezionati</button></div>
                    </div>
                </div>
            );
        };

        // --- LISTE DATI ---
        const sectorsList = ['PUBBLICO', 'PRIVATO', 'INFRASTRUTTURE', 'EDILIZIA INDUSTRIALE', 'IMPIANTISTICA', 'ALTRO'];
        const regionsList = ['Abruzzo', 'Basilicata', 'Calabria', 'Campania', 'Emilia-Romagna', 'Friuli-Venezia Giulia', 'Lazio', 'Liguria', 'Lombardia', 'Marche', 'Molise', 'Piemonte', 'Puglia', 'Sardegna', 'Sicilia', 'Toscana', 'Trentino-Alto Adige', 'Umbria', 'Valle d\'Aosta', 'Veneto'];
        const brandsList = ['HILTI', 'WURTH', 'MAKITA', 'BOSCH', 'BERNER'];
        const suppliesList = ['URGENZE', 'SCORTE', 'PIANIFICAZIONE', 'ALTRO'];
        const areasList = ['ITALIA', 'ESTERO'];
        const contactTypesList = ['Visita', 'Telefonata', 'Email', 'WhatsApp', 'Altro'];

        // --- SUB-VIEWS ---

        const DashboardView = () => {
            const { clients, reports, followups, ideas, orders, setView, setFollowupForm, setIdeaForm, setOrderForm, handleLogout, fileInputRef, exportToExcel, handleCleanDuplicates } = useContext(CRMContext);
            // MODIFICA: Totale solo per il mese corrente
            const currentMonthTotal = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                return orders.reduce((acc, curr) => {
                    const d = new Date(curr.createdAt); // createdAt è aggiornato con la data selezionata
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        return acc + (parseFloat(curr.amount) || 0);
                    }
                    return acc;
                }, 0);
            }, [orders]);

            return (
                <div className="space-y-6 animate-fade-in pb-32">
                    <header><h1 className="text-2xl font-bold text-gray-800">Dashboard</h1></header>
                    <div onClick={() => setView('ordersList')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:scale-95 transition-transform">
                        <div className="flex items-center space-x-2 text-blue-600"><Icons.ShoppingBag size={24} /><span className="text-xs font-bold uppercase text-gray-400">Totale Ordini Mese</span></div>
                        <div className="text-3xl font-bold text-gray-800">€ {currentMonthTotal.toFixed(2)}</div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onClick={() => setView('clients')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><Icons.Users className="text-blue-600 mb-2" size={16}/><div className="text-2xl font-bold">{clients.length}</div><div className="text-[10px] text-gray-400 uppercase font-bold">Clienti</div></div>
                        <div onClick={() => setView('followupsList')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><Icons.Target className="text-yellow-600 mb-2" size={16}/><div className="text-2xl font-bold">{followups.length}</div><div className="text-[10px] text-gray-400 uppercase font-bold">Offerte</div></div>
                        <div onClick={() => setView('ideasList')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><Icons.Lightbulb className="text-red-600 mb-2" size={16}/><div className="text-2xl font-bold">{ideas.length}</div><div className="text-[10px] text-gray-400 uppercase font-bold">Idee</div></div>
                        <div onClick={() => setView('list')} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform"><Icons.ClipboardList className="text-gray-600 mb-2" size={16}/><div className="text-2xl font-bold">{reports.length}</div><div className="text-[10px] text-gray-400 uppercase font-bold">Report</div></div>
                    </div>
                    <div className="flex flex-col gap-3">
                        <button onClick={() => setView('create')} className="w-full bg-gray-600 text-white py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg"><Icons.Plus size={22} /> Nuovo Report</button>
                        <button onClick={() => { setFollowupForm({}); setView('createFollowup'); }} className="w-full bg-yellow-500 text-white py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg"><Icons.Plus size={22} /> Nuova Offerta</button>
                        <button onClick={() => { setOrderForm({}); setView('createOrder'); }} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg"><Icons.ShoppingBag size={22} /> Nuovo Ordine</button>
                        <button onClick={() => { setIdeaForm({}); setView('createIdea'); }} className="w-full bg-red-600 text-white py-4 rounded-xl font-bold flex justify-center items-center gap-2 shadow-lg"><Icons.Plus size={22} /> Nuova Idea</button>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-4">
                        <input type="file" ref={fileInputRef} className="hidden" onChange={() => showMsg('Importazione...')} />
                        <button onClick={() => fileInputRef.current?.click()} className="p-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><Icons.Upload size={14}/> Importa</button>
                        <button onClick={exportToExcel} className="p-3 bg-green-50 text-green-600 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><Icons.Download size={14}/> Backup</button>
                        <button onClick={handleCleanDuplicates} className="p-3 bg-purple-50 text-purple-600 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><Icons.Trash2 size={14}/> Pulisci</button>
                        <button onClick={handleLogout} className="p-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs flex items-center justify-center gap-2"><Icons.LogOut size={14}/> Esci</button>
                    </div>
                </div>
            );
        };

        const TodoView = () => {
            const { reports, followups, ideas, setSelectedReport, setSelectedFollowup, setSelectedIdea, setView, toggleTaskCompletion } = useContext(CRMContext);
            const items = useMemo(() => {
                const arr = [];
                reports.forEach(r => r.nextContactDate && !r.completed && arr.push({ ...r, type: 'report', label: 'Report', date: r.nextContactDate, icon: Icons.ClipboardList }));
                followups.forEach(f => f.feedbackDate && !f.completed && arr.push({ ...f, type: 'offer', label: 'Offerta', date: f.feedbackDate, icon: Icons.Target }));
                ideas.forEach(i => i.deadline && !i.completed && arr.push({ ...i, type: 'idea', label: 'Idea', date: i.deadline, icon: Icons.Lightbulb }));
                return arr.sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [reports, followups, ideas]);
            return (
                <div className="animate-fade-in pb-32">
                    <h1 className="text-2xl font-bold mb-6">Da Fare</h1>
                    <div className="space-y-3">
                        {items.length === 0 ? <div className="text-center py-10 text-gray-400">Tutto fatto!</div> : items.map((item, idx) => (
                            <div key={idx} className="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer active:scale-95 transition-transform"
                                // MODIFICA: Navigazione al dettaglio/modifica cliccando sul ToDo con parametro di ritorno
                                onClick={() => { 
                                    // Remove UI-only props before setting form state
                                    const { icon, label, type, date, ...cleanItem } = item;
                                    const itemWithReturn = { ...cleanItem, _returnView: 'todo' };
                                    if(item.type === 'report') { setSelectedReport(itemWithReturn); setView('detail'); }
                                    else if(item.type === 'offer') { setSelectedFollowup(itemWithReturn); setView('followupDetail'); }
                                    else if(item.type === 'idea') { setSelectedIdea(itemWithReturn); setView('ideaDetail'); }
                                }}
                            >
                                <div>
                                    <div className="flex items-center gap-2 text-xs font-bold uppercase text-gray-400 mb-1"><item.icon size={12}/> {item.label}</div>
                                    <div className="font-bold text-gray-800">{item.client}</div>
                                    <div className="text-xs text-red-500 font-bold mt-1">Scade: {new Date(item.date).toLocaleDateString('it-IT')}</div>
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion(item.type === 'report' ? 'reports' : (item.type === 'offer' ? 'followups' : 'ideas'), item.id, false); }} className="p-2 bg-green-500 text-white rounded-full"><Icons.Check size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // --- NUOVI COMPONENTI DI DETTAGLIO ---
        
        const FollowupDetailView = () => {
             const { selectedFollowup: item, setView, setFollowupForm, deleteItem } = useContext(CRMContext);
             if (!item) return null;
             return (
                 <div className="animate-fade-in pb-32">
                     <div className="flex justify-between items-center mb-6">
                        <button onClick={() => setView(item._returnView || 'followupsList')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <div className="flex gap-2">
                            <button onClick={() => { setFollowupForm(item); setView('createFollowup'); }} className="p-2 text-blue-600 bg-blue-50 rounded-full"><Icons.Edit2 size={20}/></button>
                            <button onClick={async () => { if(await deleteItem('followups', item.id)) setView(item._returnView || 'followupsList'); }} className="p-2 text-red-500 bg-red-50 rounded-full"><Icons.Trash2 size={20}/></button>
                        </div>
                     </div>
                     <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                        <InfoBox label="Cliente" value={item.client} icon={Icons.Users} />
                        <InfoBox label="N. Offerta" value={item.offerNumber} icon={Icons.FileText} />
                        <InfoBox label="Importo" value={`€ ${parseFloat(item.amount).toFixed(2)}`} icon={Icons.CreditCard} />
                        <InfoBox label="Data Riscontro" value={new Date(item.feedbackDate).toLocaleDateString('it-IT')} icon={Icons.Calendar} />
                        <SectionDisplay title="Note" content={item.notes} />
                     </div>
                 </div>
             );
        };

        const IdeaDetailView = () => {
             const { selectedIdea: item, setView, setIdeaForm, deleteItem } = useContext(CRMContext);
             if (!item) return null;
             return (
                 <div className="animate-fade-in pb-32">
                     <div className="flex justify-between items-center mb-6">
                        <button onClick={() => setView(item._returnView || 'ideasList')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <div className="flex gap-2">
                            <button onClick={() => { setIdeaForm(item); setView('createIdea'); }} className="p-2 text-blue-600 bg-blue-50 rounded-full"><Icons.Edit2 size={20}/></button>
                            <button onClick={async () => { if(await deleteItem('ideas', item.id)) setView(item._returnView || 'ideasList'); }} className="p-2 text-red-500 bg-red-50 rounded-full"><Icons.Trash2 size={20}/></button>
                        </div>
                     </div>
                     <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                        <InfoBox label="Cliente" value={item.client} icon={Icons.Users} />
                        <InfoBox label="Scadenza" value={new Date(item.deadline).toLocaleDateString('it-IT')} icon={Icons.Calendar} />
                        <SectionDisplay title="Idea" content={item.text} />
                     </div>
                 </div>
             );
        };

        const ClientCompletedTodosView = () => {
             const { reports, followups, ideas, selectedClient, setView, toggleTaskCompletion } = useContext(CRMContext);
             if(!selectedClient) return null;
             const items = useMemo(() => {
                const arr = [];
                reports.filter(r => r.client === selectedClient.ragioneSociale).forEach(r => r.nextContactDate && r.completed && arr.push({ ...r, type: 'report', label: 'Report', date: r.nextContactDate, icon: Icons.ClipboardList }));
                followups.filter(f => f.client === selectedClient.ragioneSociale).forEach(f => f.feedbackDate && f.completed && arr.push({ ...f, type: 'offer', label: 'Offerta', date: f.feedbackDate, icon: Icons.Target }));
                ideas.filter(i => i.client === selectedClient.ragioneSociale).forEach(i => i.deadline && i.completed && arr.push({ ...i, type: 'idea', label: 'Idea', date: i.deadline, icon: Icons.Lightbulb }));
                return arr.sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [reports, followups, ideas, selectedClient]);

            return (
                 <div className="animate-fade-in pb-32">
                     <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => setView('clientDetail')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <h1 className="text-xl font-bold">Completati: {selectedClient.ragioneSociale}</h1>
                     </div>
                    <div className="space-y-3">
                        {items.length === 0 ? <div className="text-center py-10 text-gray-400">Nessuna attività completata.</div> : items.map((item, idx) => (
                            <div key={idx} className="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center opacity-75">
                                <div>
                                    <div className="flex items-center gap-2 text-xs font-bold uppercase text-gray-400 mb-1"><item.icon size={12}/> {item.label}</div>
                                    <div className="font-bold text-gray-800 strike-through line-through">{item.client}</div>
                                    <div className="text-xs text-gray-500 font-bold mt-1">Completato: {new Date(item.date).toLocaleDateString('it-IT')}</div>
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); toggleTaskCompletion(item.type === 'report' ? 'reports' : (item.type === 'offer' ? 'followups' : 'ideas'), item.id, true); }} className="p-2 bg-gray-200 text-gray-600 rounded-full text-xs">Ripristina</button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };


        const StatsView = () => {
            const { reports, orders } = useContext(CRMContext);
            const [sortBy, setSortBy] = useState('orders'); // 'orders', 'hours', 'commissions'

            const data = useMemo(() => {
                const map = {};
                reports.forEach(r => { if(!map[r.client]) map[r.client] = { orders: 0, hours: 0, commissions: 0 }; map[r.client].hours += parseFloat(r.hours || 0); });
                orders.forEach(o => { 
                    if(!map[o.client]) map[o.client] = { orders: 0, hours: 0, commissions: 0 }; 
                    map[o.client].orders += parseFloat(o.amount || 0); 
                    map[o.client].commissions += parseFloat(o.commission || 0);
                });
                
                let arr = Object.entries(map).map(([name, v]) => ({ name, ...v }));

                if (sortBy === 'orders') arr = arr.sort((a,b) => b.orders - a.orders);
                else if (sortBy === 'hours') arr = arr.sort((a,b) => b.hours - a.hours);
                else if (sortBy === 'commissions') arr = arr.sort((a,b) => b.commissions - a.commissions);

                return arr;
            }, [reports, orders, sortBy]);

            const maxOrders = Math.max(...data.map(d => d.orders), 1);
            const maxHours = Math.max(...data.map(d => d.hours), 1);
            const maxCommissions = Math.max(...data.map(d => d.commissions), 1);

            return (
                <div className="animate-fade-in pb-32">
                    <h1 className="text-2xl font-bold mb-6">Situazione</h1>
                    
                    <div className="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                         <button onClick={() => setSortBy('orders')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap ${sortBy === 'orders' ? 'bg-blue-600 text-white' : 'bg-white text-gray-600 border'}`}>Ordini</button>
                         <button onClick={() => setSortBy('hours')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap ${sortBy === 'hours' ? 'bg-purple-600 text-white' : 'bg-white text-gray-600 border'}`}>Ore</button>
                         <button onClick={() => setSortBy('commissions')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap ${sortBy === 'commissions' ? 'bg-yellow-600 text-white' : 'bg-white text-gray-600 border'}`}>Provvigioni</button>
                    </div>

                    <div className="space-y-4">
                        {data.map(item => (
                            <div key={item.name} className="bg-white p-4 rounded-xl border border-gray-100">
                                <div className="font-bold text-gray-800 mb-2">{item.name}</div>
                                
                                <div className="mb-2">
                                    <div className="flex justify-between text-xs text-gray-500 mb-1"><span>Ordini</span><span>€{item.orders.toFixed(2)}</span></div>
                                    <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-blue-500 rounded-full" style={{width: `${(item.orders / maxOrders) * 100}%`}}></div>
                                    </div>
                                </div>

                                <div className="mb-2">
                                    <div className="flex justify-between text-xs text-gray-500 mb-1"><span>Ore</span><span>{item.hours.toFixed(1)}h</span></div>
                                    <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-purple-500 rounded-full" style={{width: `${(item.hours / maxHours) * 100}%`}}></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-xs text-gray-500 mb-1"><span>Provvigioni</span><span>€{item.commissions.toFixed(2)}</span></div>
                                    <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-yellow-500 rounded-full" style={{width: `${(item.commissions / maxCommissions) * 100}%`}}></div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ClientsList = () => {
            const { clients, reports, setView, setSelectedClient, setClientForm } = useContext(CRMContext);
            const [search, setSearch] = useState('');
            // MODIFICA: Ordinamento alfabetico
            const filtered = clients
                .filter(c => normalizeForSearch(c.ragioneSociale || '').includes(normalizeForSearch(search)))
                .sort((a, b) => (a.ragioneSociale || '').localeCompare(b.ragioneSociale || ''));
            
            const getStatusBadge = (clientName) => {
                const clientReports = reports.filter(r => r.client === clientName).sort((a,b) => new Date(b.date) - new Date(a.date));
                
                if(clientReports.length === 0) {
                    return <span className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-[10px] font-bold uppercase">Mai Contattato</span>;
                }
                
                const days = (new Date() - new Date(clientReports[0].date)) / (1000 * 60 * 60 * 24);
                
                if(days < 15) return <span className="px-2 py-1 rounded bg-red-100 text-red-600 text-[10px] font-bold uppercase">Caldo</span>;
                if(days <= 30) return <span className="px-2 py-1 rounded bg-orange-100 text-orange-600 text-[10px] font-bold uppercase">Tiepido</span>;
                return <span className="px-2 py-1 rounded bg-blue-100 text-blue-600 text-[10px] font-bold uppercase">Freddo</span>;
            };

            const isIncomplete = (c) => !c.telefono || !c.email || !c.pIva;

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Clienti</h2>
                        <button onClick={() => { setClientForm({}); setView('createClient'); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1"><Icons.Plus size={16}/> Nuovo</button>
                    </div>
                    <div className="mb-4 relative"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><Icons.Search size={18}/></div><input type="text" placeholder="Cerca cliente..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" /></div>
                    <div className="space-y-3">
                        {filtered.length === 0 ? <div className="text-center py-10 text-gray-400">Nessun cliente trovato.</div> : filtered.map(c => (
                            <div key={c.id} onClick={() => { setSelectedClient(c); setView('clientDetail'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform flex flex-col gap-2">
                                <div className="flex justify-between items-start">
                                    <div className="font-bold text-gray-800 flex items-center gap-2">
                                        {c.ragioneSociale}
                                        {isIncomplete(c) && <Icons.AlertTriangle size={14} className="text-orange-500" />}
                                    </div>
                                    {getStatusBadge(c.ragioneSociale)}
                                </div>
                                <div className="text-xs text-gray-400">{c.sedeOperativa || c.sedeLegale || '-'}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const FollowupsListView = () => {
             const { followups, setView, setFollowupForm } = useContext(CRMContext);
             const totalAmount = useMemo(() => followups.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0), [followups]);

             return (
                 <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Lista Offerte</h2>
                        <button onClick={() => { setFollowupForm({}); setView('createFollowup'); }} className="bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1">
                            <Icons.Plus size={16}/> Nuova
                        </button>
                    </div>
                    
                    {/* Totale Offerte */}
                    <div className="bg-yellow-500 p-5 rounded-2xl shadow-lg text-white mb-6">
                        <div className="text-xs font-bold uppercase opacity-80 mb-1">Totale Offerte</div>
                        <div className="text-3xl font-bold">€ {totalAmount.toFixed(2)}</div>
                    </div>

                    <div className="space-y-3">
                        {followups.map(f => (
                            <div key={f.id} onClick={() => { setFollowupForm(f); setView('createFollowup'); }} className="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <div className="font-bold text-gray-800">{f.client}</div>
                                        <div className="text-xs text-gray-500 mt-1">Offerta n. {f.offerNumber}</div>
                                        <div className="text-xs text-gray-400 mt-0.5">Riscontro: {new Date(f.feedbackDate).toLocaleDateString('it-IT')}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-lg font-bold text-yellow-600">€ {parseFloat(f.amount).toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                 </div>
             )
        };

        const IdeasListView = () => {
             const { ideas, setView, setIdeaForm } = useContext(CRMContext);
             return (
                 <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Lista Idee</h2>
                        <button onClick={() => { setIdeaForm({}); setView('createIdea'); }} className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1">
                            <Icons.Plus size={16}/> Nuova
                        </button>
                    </div>
                    <div className="space-y-3">
                        {ideas.map(i => (
                            <div key={i.id} onClick={() => { setIdeaForm(i); setView('createIdea'); }} className="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform">
                                <div className="font-bold text-gray-800">{i.client}</div>
                                <div className="text-sm mt-1">{i.text}</div>
                                <div className="text-xs text-red-500 mt-1 font-bold">Scadenza: {new Date(i.deadline).toLocaleDateString('it-IT')}</div>
                            </div>
                        ))}
                    </div>
                 </div>
             )
        };


        const ClientForm = () => {
            const { clientForm: initialData, saveClient, setView, clients } = useContext(CRMContext);
            const [formData, setFormData] = useState({ contact1: {}, contact2: {}, contact3: {}, contact4: {}, ...initialData });
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));
            const handleContactChange = (e, index) => {
                const { name, value } = e.target;
                setFormData(p => ({ ...p, [`contact${index}`]: { ...p[`contact${index}`], [name]: value } }));
            };

            const jobTitles = useMemo(() => {
                const set = new Set();
                clients.forEach(c => {
                    for(let i=1; i<=4; i++) {
                        if(c[`contact${i}`]?.mansione) set.add(c[`contact${i}`].mansione);
                    }
                });
                return Array.from(set).sort();
            }, [clients]);

            return (
                <div className="animate-fade-in pb-32">
                    <div className="sticky top-0 bg-gray-100/95 py-4 flex justify-between items-center z-20">
                        <h2 className="text-xl font-bold">{formData.id ? 'Modifica Cliente' : 'Nuovo Cliente'}</h2>
                        <button onClick={() => setView('clients')}><Icons.X size={20}/></button>
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); saveClient(formData); }} className="space-y-6">
                        <SectionContainer title="Anagrafica" icon={Icons.Building2}>
                            <Input label="Ragione Sociale *" name="ragioneSociale" value={formData.ragioneSociale} onChange={handleChange} required />
                            <Input label="Partita IVA" name="pIva" value={formData.pIva} onChange={handleChange} />
                            <Input label="Telefono" name="telefono" value={formData.telefono} onChange={handleChange} />
                            <Input label="Email" type="email" name="email" value={formData.email} onChange={handleChange} />
                            <Input label="PEC" type="email" name="pec" value={formData.pec} onChange={handleChange} />
                            <Input label="Codice Univoco (SDI)" name="sdiCode" value={formData.sdiCode} onChange={handleChange} />
                        </SectionContainer>
                        <SectionContainer title="Sedi e Logistica" icon={Icons.MapPin}>
                            <Input label="Sede Legale" name="sedeLegale" value={formData.sedeLegale} onChange={handleChange} />
                            <Input label="Sede Operativa" name="sedeOperativa" value={formData.sedeOperativa} onChange={handleChange} />
                            <Input label="Magazzino" name="magazzino" value={formData.magazzino} onChange={handleChange} />
                        </SectionContainer>
                        <SectionContainer title="Mercato" icon={Icons.Target}>
                            <MultiSelect label="Settore" name="settore" value={formData.settore} onChange={handleChange} options={sectorsList} />
                            <MultiSelect label="Aree Geografiche" name="areeGeografiche" value={formData.areeGeografiche} onChange={handleChange} options={areasList} height="max-h-auto" />
                            <MultiSelect label="Regioni" name="regioni" value={formData.regioni} onChange={handleChange} options={regionsList} />
                        </SectionContainer>
                        <SectionContainer title="Amministrazione" icon={Icons.CreditCard}>
                            <Input label="Metodo Pagamento" name="pagamento" value={formData.pagamento} onChange={handleChange} />
                            <Input label="Fido (€)" type="number" name="fido" value={formData.fido} onChange={handleChange} />
                            <Input label="Data Fido" type="date" name="dataFido" value={formData.dataFido} onChange={handleChange} />
                        </SectionContainer>
                        <SectionContainer title="Operatività" icon={Icons.Users}>
                            <Input label="N. Operai" type="number" name="nOperai" value={formData.nOperai} onChange={handleChange} />
                            <Input label="Abbigliamento" name="abbigliamento" value={formData.abbigliamento} onChange={handleChange} />
                            <Input label="Cantieri Attivi" name="cantieriAttivi" value={formData.cantieriAttivi} onChange={handleChange} />
                            <TextArea label="Note Cantieri" name="noteCantieri" value={formData.noteCantieri} onChange={handleChange} />
                            <Input label="Sub-Appalti" name="subAppalti" value={formData.subAppalti} onChange={handleChange} />
                            <TextArea label="Processi Decisionali" name="processiDecisionali" value={formData.processiDecisionali} onChange={handleChange} />
                        </SectionContainer>
                        <SectionContainer title="Commerciale" icon={Icons.ShoppingBag}>
                            <SelectComponent label="Brand Principale" name="brand" value={formData.brand} onChange={handleChange} options={brandsList} />
                            <Input label="Altri Brand" name="altriBrand" value={formData.altriBrand} onChange={handleChange} />
                            <TextArea label="Prodotti Trattati" name="prodotti" value={formData.prodotti} onChange={handleChange} />
                            <SelectComponent label="Frequenza Approvvigionamenti" name="approvvigionamenti" value={formData.approvvigionamenti} onChange={handleChange} options={suppliesList} />
                            <TextArea label="Preferenza Fornitori Abituali" name="prefFornitori" value={formData.prefFornitori} onChange={handleChange} />
                            <Input label="Pagamenti Abituali" name="pagamentiAbituali" value={formData.pagamentiAbituali} onChange={handleChange} />
                        </SectionContainer>
                        <SectionContainer title="Note e Valutazioni" icon={Icons.Edit2}>
                            <TextArea label="Note Interne" name="noteInterne" value={formData.noteInterne} onChange={handleChange} />
                            <TextArea label="Comunicazioni" name="comunicazioni" value={formData.comunicazioni} onChange={handleChange} />
                            <TextArea label="Note Generali" name="noteGenerali" value={formData.noteGenerali} onChange={handleChange} />
                            <TextArea label="Conclusione" name="conclusione" value={formData.conclusione} onChange={handleChange} />
                            <SelectComponent label="Valutazione" name="valutazione" value={formData.valutazione} onChange={handleChange} options={['1','2','3','4','5']} />
                        </SectionContainer>
                        {[1, 2, 3, 4].map(idx => (
                            <SectionContainer key={idx} title={`Contatto ${idx}`} icon={Icons.Users}>
                                <Input label="Nome" name="nome" value={formData[`contact${idx}`]?.nome} onChange={(e) => handleContactChange(e, idx)} />
                                <div className="mb-3">
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Mansione</label>
                                    <input type="text" list={`mansioni-list-${idx}`} name="mansione" value={formData[`contact${idx}`]?.mansione || ''} onChange={(e) => handleContactChange(e, idx)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" />
                                    <datalist id={`mansioni-list-${idx}`}>
                                        {jobTitles.map(t => <option key={t} value={t} />)}
                                    </datalist>
                                </div>
                                <Input label="Tel" name="tel" value={formData[`contact${idx}`]?.tel} onChange={(e) => handleContactChange(e, idx)} />
                                <Input label="Mail" name="mail" value={formData[`contact${idx}`]?.mail} onChange={(e) => handleContactChange(e, idx)} />
                            </SectionContainer>
                        ))}
                        <div className="flex gap-3 pt-4"><button type="button" onClick={() => setView('clients')} className="flex-1 py-4 bg-gray-100 rounded-xl font-bold">Annulla</button><button type="submit" className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold">Salva</button></div>
                    </form>
                </div>
            );
        };

        const ClientDetailView = () => {
            const { selectedClient: c, setView, setClientForm, deleteItem, orders } = useContext(CRMContext);
            if (!c) return null;
            const clientOrders = orders.filter(o => o.client === c.ragioneSociale);
            const totalOrders = clientOrders.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6"><button onClick={() => setView('clients')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button><div className="flex gap-2"><button onClick={() => { setClientForm(c); setView('createClient'); }} className="p-2 text-blue-600 bg-blue-50 rounded-full"><Icons.Edit2 size={20}/></button><button onClick={async () => { if(await deleteItem('clients', c.id)) setView('clients'); }} className="p-2 text-red-500 bg-red-50 rounded-full"><Icons.Trash2 size={20}/></button></div></div>
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border">
                            <h1 className="text-2xl font-bold text-gray-900 mb-1">{c.ragioneSociale}</h1>
                            <div className="text-xs text-gray-400 font-bold mb-4 uppercase">P.IVA: {c.pIva || '-'}</div>
                            <div className="pt-4 border-t grid grid-cols-2 gap-4">
                                <div><div className="text-[10px] text-gray-400 uppercase font-bold mb-1">Ordini</div><div className="text-lg font-bold text-blue-600">€{totalOrders.toFixed(2)}</div></div>
                                <div><div className="text-[10px] text-gray-400 uppercase font-bold mb-1">Fido</div><div className="text-lg font-bold">€{parseFloat(c.fido || 0).toFixed(2)}</div></div>
                            </div>
                        </div>
                        
                        <button onClick={() => setView('clientCompletedTodos')} className="w-full py-3 bg-green-50 text-green-600 font-bold rounded-xl flex items-center justify-center gap-2"><Icons.CheckSquare size={16}/> TO-DO Completati</button>

                        <SectionContainer title="Anagrafica" icon={Icons.Building2}>
                            <InfoRow label="Telefono" value={c.telefono} /><InfoRow label="Email" value={c.email} /><InfoRow label="PEC" value={c.pec} /><InfoRow label="SDI" value={c.sdiCode} />
                        </SectionContainer>
                        <SectionContainer title="Logistica" icon={Icons.MapPin}><InfoRow label="Sede Legale" value={c.sedeLegale} /><InfoRow label="Sede Operativa" value={c.sedeOperativa} /><InfoRow label="Magazzino" value={c.magazzino} /></SectionContainer>
                        <SectionContainer title="Mercato" icon={Icons.Target}><InfoRow label="Settore" value={c.settore} /><InfoRow label="Aree" value={c.areeGeografiche} /><InfoRow label="Regioni" value={c.regioni} /></SectionContainer>
                        <SectionContainer title="Amministrazione" icon={Icons.CreditCard}><InfoRow label="Pagamento" value={c.pagamento} /><InfoRow label="Data Fido" value={c.dataFido} /></SectionContainer>
                        <SectionContainer title="Operatività" icon={Icons.Users}>
                            <InfoRow label="N. Operai" value={c.nOperai} /><InfoRow label="Abbigliamento" value={c.abbigliamento} /><InfoRow label="Cantieri" value={c.cantieriAttivi} />
                            <SectionDisplay title="Note Cantieri" content={c.noteCantieri} small /><InfoRow label="Sub-Appalti" value={c.subAppalti} />
                            <SectionDisplay title="Processi" content={c.processiDecisionali} small />
                        </SectionContainer>
                        <SectionContainer title="Commerciale" icon={Icons.ShoppingBag}>
                            <InfoRow label="Brand" value={c.brand} /><InfoRow label="Altri" value={c.altriBrand} /><SectionDisplay title="Prodotti" content={c.prodotti} small />
                            <InfoRow label="Approvvigionamenti" value={c.approvvigionamenti} /><SectionDisplay title="Fornitori" content={c.prefFornitori} small /><InfoRow label="Pagamenti Abit." value={c.pagamentiAbituali} />
                        </SectionContainer>
                        <SectionContainer title="Valutazioni" icon={Icons.Edit2}>
                            <SectionDisplay title="Note Interne" content={c.noteInterne} small /><SectionDisplay title="Comunicazioni" content={c.comunicazioni} small /><SectionDisplay title="Note Generali" content={c.noteGenerali} small />
                            <SectionDisplay title="Conclusione" content={c.conclusione} small /><InfoRow label="Valutazione" value={c.valutazione} />
                        </SectionContainer>
                        {[1, 2, 3, 4].map(idx => {
                            const ct = c[`contact${idx}`];
                            if(!ct?.nome) return null;
                            return ( <SectionContainer key={idx} title={`Contatto ${idx}`} icon={Icons.Users}><InfoRow label="Nome" value={ct.nome} /><InfoRow label="Mansione" value={ct.mansione} /><InfoRow label="Tel" value={ct.tel} /><InfoRow label="Mail" value={ct.mail} /></SectionContainer> );
                        })}
                        <div className="grid grid-cols-2 gap-3 pt-4">
                            <button onClick={() => setView('clientReports')} className="bg-white p-4 rounded-xl border flex flex-col items-center gap-1"><Icons.ClipboardList size={20} className="text-gray-400"/><span className="text-xs font-bold">Report</span></button>
                            <button onClick={() => setView('clientOrders')} className="bg-white p-4 rounded-xl border flex flex-col items-center gap-1"><Icons.ShoppingBag size={20} className="text-blue-500"/><span className="text-xs font-bold">Ordini</span></button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportForm = () => {
            const { reportForm: initialData, saveReport, setView, clients } = useContext(CRMContext);
            // MODIFICA: Inizializzo nextContactTime con default 09:00 se non presente
            const [formData, setFormData] = useState({ 
                ...initialData, 
                nextContactTime: initialData.nextContactTime || "09:00" 
            });
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));
            const selectedClientData = useMemo(() => clients.find(c => c.ragioneSociale === formData.client), [clients, formData.client]);
            const availableContacts = selectedClientData ? [selectedClientData.contact1, selectedClientData.contact2, selectedClientData.contact3, selectedClientData.contact4].filter(c => c?.nome) : [];
            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica' : 'Nuovo'} Report</h2>
                    <form onSubmit={(e) => { e.preventDefault(); saveReport(formData); }} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                        {availableContacts.length > 0 && (
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Referente</label><select name="contactRef" value={formData.contactRef} onChange={handleChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"><option value="">Seleziona...</option>{availableContacts.map((c, idx) => (<option key={idx} value={c.nome}>{c.nome}</option>))}</select></div>
                        )}
                        <div className="grid grid-cols-2 gap-4"><Input label="Data" type="date" name="date" value={formData.date} onChange={handleChange} required /><TimeWheelPicker value={formData.hours} onChange={(val) => setFormData(prev => ({...prev, hours: val}))} /></div>
                        {/* MODIFICA: Aggiunto campo Tipo Contatto */}
                        <SelectComponent label="Tipo Contatto" name="contactType" value={formData.contactType} onChange={handleChange} options={contactTypesList} />
                        <SelectComponent label="Categoria" name="category" value={formData.category} onChange={handleChange} options={['MANTENIMENTO RAPPORTO', 'ORDINE', 'RICHIESTA OFFERTA', 'RISCONTRO OFFERTA', 'INIZIO RAPPORTO', 'APPUNTAMENTO', 'ALTRO']} />
                        <TextArea label="Descrizione" name="description" value={formData.description} onChange={handleChange} enableVoice={true} />
                        <SectionContainer title="Follow-up" icon={Icons.AlarmCheck}>
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Prossimo Contatto (Data)" type="date" name="nextContactDate" value={formData.nextContactDate} onChange={handleChange} />
                                <Input label="Ora" type="time" name="nextContactTime" value={formData.nextContactTime} onChange={handleChange} />
                            </div>
                            <TextArea label="Appunti Futuri" name="futureNotes" value={formData.futureNotes} onChange={handleChange} />
                            {/* MODIFICA: Aggiunto pulsante Google Calendar nel form */}
                            {formData.nextContactDate && (
                                <div className="pt-2">
                                    <CalendarButton 
                                        title={`Follow-up: ${formData.client || 'Cliente'}`} 
                                        details={formData.futureNotes || ""} 
                                        date={formData.nextContactDate} 
                                        time={formData.nextContactTime || "09:00"} 
                                    />
                                </div>
                            )}
                        </SectionContainer>
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView(formData._returnView || 'dashboard')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-gray-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const ReportList = () => {
            const { reports, setView, setSelectedReport, setReportForm } = useContext(CRMContext);
            const [search, setSearch] = useState('');
            // MODIFICA: Ordinamento decrescente per data report e poi per data creazione
            const filtered = reports
                .filter(r => normalizeForSearch(r.client).includes(normalizeForSearch(search)) || (r.description || '').toLowerCase().includes(search.toLowerCase()))
                .sort((a, b) => {
                    const d1 = new Date(b.date).getTime();
                    const d2 = new Date(a.date).getTime();
                    if (d1 !== d2) return d1 - d2;
                    return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();
                });

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Storico Report</h2>
                        <button onClick={() => { setReportForm({}); setView('create'); }} className="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1">
                            <Icons.Plus size={16}/> Nuovo
                        </button>
                    </div>
                    <div className="mb-4 relative"><Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/><input type="text" placeholder="Cerca..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 p-3 bg-white border border-gray-200 rounded-xl text-sm outline-none" /></div>
                    <div className="space-y-3">
                        {filtered.map(r => (<div key={r.id} onClick={() => { setSelectedReport(r); setView('detail'); }} className="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform"><div className="font-bold text-gray-800">{r.client}</div><div className="text-xs text-gray-500 mt-1">{new Date(r.date).toLocaleDateString('it-IT')} - {r.category}</div></div>))}
                    </div>
                </div>
            );
        };

        const ReportDetailView = () => {
            const { selectedReport: report, setView, setReportForm, deleteItem } = useContext(CRMContext);
            if (!report) return null;
            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6"><button onClick={() => setView(report._returnView || 'list')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button><div className="flex gap-2"><button onClick={() => { setReportForm(report); setView('create'); }} className="p-2 text-blue-600 bg-blue-50 rounded-full"><Icons.Edit2 size={20}/></button><button onClick={async () => { if(await deleteItem('reports', report.id)) setView(report._returnView || 'list'); }} className="p-2 text-red-500 bg-red-50 rounded-full"><Icons.Trash2 size={20}/></button></div></div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                        <InfoBox label="Cliente" value={report.client} icon={Icons.Users} /><InfoBox label="Data" value={new Date(report.date).toLocaleDateString('it-IT')} icon={Icons.Calendar} />
                        {/* MODIFICA: Visualizzazione Tipo Contatto */}
                        <InfoBox label="Tipo Contatto" value={report.contactType} icon={Icons.Phone} />
                        <InfoBox label="Categoria" value={report.category} icon={Icons.Target} />
                        <SectionDisplay title="Descrizione" content={report.description} />
                        {report.futureNotes && <SectionDisplay title="Appunti Futuri" content={report.futureNotes} small />}
                        {report.nextContactDate && (
                            <CalendarButton 
                                title={`Follow-up: ${report.client}`} 
                                details={report.futureNotes || "Nessuna nota"} 
                                date={report.nextContactDate} 
                                time={report.nextContactTime || "09:00"} 
                            />
                        )}
                    </div>
                </div>
            );
        };

        // FIX: Vista Report per Cliente Specifico
        const ClientReportsView = () => {
            const { reports, selectedClient, setView, setSelectedReport } = useContext(CRMContext);
            if(!selectedClient) return null;
            // MODIFICA: Ordinamento decrescente per data report e poi per data creazione
            const filtered = reports
                .filter(r => r.client === selectedClient.ragioneSociale)
                .sort((a, b) => {
                    const d1 = new Date(b.date).getTime();
                    const d2 = new Date(a.date).getTime();
                    if (d1 !== d2) return d1 - d2;
                    return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();
                });

            return (
                <div className="animate-fade-in pb-32">
                     <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => setView('clientDetail')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <h2 className="text-xl font-bold">Report: {selectedClient.ragioneSociale}</h2>
                    </div>
                    <div className="space-y-3">
                        {filtered.length === 0 ? <div className="text-center py-10 text-gray-400">Nessun report.</div> : filtered.map(r => (<div key={r.id} onClick={() => { setSelectedReport(r); setView('detail'); }} className="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform"><div className="font-bold text-gray-800">{new Date(r.date).toLocaleDateString('it-IT')}</div><div className="text-xs text-gray-500 mt-1">{r.category}</div></div>))}
                    </div>
                </div>
            );
        };

        const FollowupForm = () => {
            const { followupForm: initialData, saveFollowup, setView, clients } = useContext(CRMContext);
            const [formData, setFormData] = useState(initialData);
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));
            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica Offerta' : 'Nuova Offerta'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); saveFollowup(formData); }} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                        <Input label="N. Offerta" name="offerNumber" value={formData.offerNumber} onChange={handleChange} required />
                        <Input label="Importo (€)" type="number" step="0.01" name="amount" value={formData.amount} onChange={handleChange} required />
                        <Input label="Data Riscontro" type="date" name="feedbackDate" value={formData.feedbackDate} onChange={handleChange} required />
                        <TextArea label="Note" name="notes" value={formData.notes} onChange={handleChange} />
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView(formData._returnView || 'dashboard')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const OrderForm = () => {
            const { orderForm: initialData, saveOrder, setView, clients } = useContext(CRMContext);
            
            // Initialize with date handling
            const [formData, setFormData] = useState(() => {
                const defaultDate = initialData.createdAt 
                    ? new Date(initialData.createdAt).toISOString().split('T')[0] 
                    : new Date().toISOString().split('T')[0];
                return { ...initialData, dateInput: defaultDate };
            });

            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));
            
            const handleSubmit = (e) => {
                e.preventDefault();
                // Ensure the createdAt timestamp matches the selected date
                const finalData = {
                    ...formData,
                    createdAt: new Date(formData.dateInput).toISOString() 
                };
                delete finalData.dateInput;
                saveOrder(finalData);
            };

            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica Ordine' : 'Nuovo Ordine'}</h2>
                    <form onSubmit={handleSubmit} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                        <div className="grid grid-cols-2 gap-4">
                            <Input label="Data" type="date" name="dateInput" value={formData.dateInput} onChange={handleChange} required />
                            <Input label="N. Ordine" name="offerNumber" value={formData.offerNumber} onChange={handleChange} required />
                        </div>
                        <Input label="Importo (€)" type="number" step="0.01" name="amount" value={formData.amount} onChange={handleChange} required />
                        <Input label="Provvigione (€)" type="number" step="0.01" name="commission" value={formData.commission} onChange={handleChange} required />
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView('ordersList')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const IdeaForm = () => {
            const { ideaForm: initialData, saveIdea, setView, clients } = useContext(CRMContext);
            const [formData, setFormData] = useState(initialData);
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));
            return (
                <div className="animate-fade-in pb-32">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">{formData.id ? 'Modifica Idea' : 'Nuova Idea'}</h2>
                    <form onSubmit={(e) => { e.preventDefault(); saveIdea(formData); }} className="space-y-5 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <ClientSearchInput clients={clients} value={formData.client} onChange={handleChange} required />
                        <TextArea label="Testo Idea" name="text" value={formData.text} onChange={handleChange} required enableVoice={true} />
                        <Input label="Scadenza" type="date" name="deadline" value={formData.deadline} onChange={handleChange} required />
                        <div className="pt-2 flex gap-3"><button type="button" onClick={() => setView(formData._returnView || 'ideas')} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl">Annulla</button><button type="submit" className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><Icons.Save size={18} /> Salva</button></div>
                    </form>
                </div>
            );
        };

        const OrdersListView = () => {
            const { orders, setView, setOrderForm } = useContext(CRMContext);
            
            const { groups, grandTotal, sortedMonths } = useMemo(() => {
                // Modifica ordinamento: per numero ordine decrescente
                const sorted = [...orders].sort((a, b) => {
                    const valA = a.offerNumber || '';
                    const valB = b.offerNumber || '';
                    return valB.localeCompare(valA, undefined, { numeric: true, sensitivity: 'base' });
                });

                const g = {};
                const months = [];
                let tot = 0;
                
                sorted.forEach(o => {
                    const d = new Date(o.createdAt);
                    if(isNaN(d.getTime())) return;
                    const k = d.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                    const key = k.charAt(0).toUpperCase() + k.slice(1);
                    
                    if(!g[key]) {
                        g[key] = { items: [], total: 0 };
                        months.push(key);
                    }
                    g[key].items.push(o);
                    g[key].total += parseFloat(o.amount || 0);
                    tot += parseFloat(o.amount || 0);
                });
                
                return { groups: g, grandTotal: tot, sortedMonths: months };
            }, [orders]);

            // Data for chart
            const chartData = [...sortedMonths].reverse().map(m => ({ label: m.split(' ')[0].substring(0, 3), value: groups[m].total }));

            return (
                <div className="animate-fade-in pb-32">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Storico Ordini</h2>
                        <button onClick={() => { setOrderForm({}); setView('createOrder'); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1">
                            <Icons.Plus size={16}/> Nuovo
                        </button>
                    </div>
                    
                    <div className="bg-blue-600 p-5 rounded-2xl shadow-lg text-white mb-6">
                        <div className="text-xs font-bold uppercase opacity-80 mb-1">Totale Complessivo</div>
                        <div className="text-3xl font-bold">€ {grandTotal.toFixed(2)}</div>
                    </div>

                    {chartData.length > 0 && <MonthChart data={chartData} />}

                    <div className="space-y-6">
                        {sortedMonths.length === 0 ? <div className="text-center py-10 text-gray-400">Nessun ordine.</div> :
                        sortedMonths.map(month => (
                            <div key={month}>
                                <div className="flex justify-between items-end mb-2 px-1">
                                    <h3 className="font-bold text-gray-500 uppercase text-sm">{month}</h3>
                                    <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">€ {groups[month].total.toFixed(2)}</span>
                                </div>
                                <div className="space-y-3">
                                    {groups[month].items.map(o => (
                                        <div key={o.id} onClick={() => { setOrderForm(o); setView('createOrder'); }} className="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform">
                                            <div className="flex justify-between font-bold text-gray-800">
                                                <span>{o.client}</span>
                                                <div className="text-right">
                                                    <div className="text-blue-600">€{parseFloat(o.amount).toFixed(2)}</div>
                                                    {o.commission > 0 && <div className="text-[10px] text-gray-400 font-normal">Provv. €{parseFloat(o.commission).toFixed(2)}</div>}
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">Ordine: {o.offerNumber} - {new Date(o.createdAt).toLocaleDateString('it-IT')}</div>
                                        </div>
                                    ))}
                                </div>
                                {/* Totale Mensile Footer */}
                                <div className="flex justify-end mt-2 mb-4 border-t border-gray-100 pt-2">
                                    <div className="text-sm font-bold text-gray-600">Totale {month}: <span className="text-blue-600">€ {groups[month].total.toFixed(2)}</span></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // FIX: Vista Ordini per Cliente Specifico
        const ClientOrdersView = () => {
            const { orders, selectedClient, setView, setOrderForm } = useContext(CRMContext);
            
            const { groups, grandTotal, sortedMonths } = useMemo(() => {
                if (!selectedClient) return { groups: {}, grandTotal: 0, sortedMonths: [] };
                const filtered = orders.filter(o => o.client === selectedClient.ragioneSociale);
                
                // Modifica ordinamento: per numero ordine decrescente
                const sorted = [...filtered].sort((a, b) => {
                    const valA = a.offerNumber || '';
                    const valB = b.offerNumber || '';
                    return valB.localeCompare(valA, undefined, { numeric: true, sensitivity: 'base' });
                });

                const g = {};
                const months = [];
                let tot = 0;
                
                sorted.forEach(o => {
                    const d = new Date(o.createdAt);
                    if(isNaN(d.getTime())) return;
                    const k = d.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                    const key = k.charAt(0).toUpperCase() + k.slice(1);
                    
                    if(!g[key]) {
                        g[key] = { items: [], total: 0 };
                        months.push(key);
                    }
                    g[key].items.push(o);
                    g[key].total += parseFloat(o.amount || 0);
                    tot += parseFloat(o.amount || 0);
                });
                
                return { groups: g, grandTotal: tot, sortedMonths: months };
            }, [orders, selectedClient]);

            if(!selectedClient) return null;

            // Data for chart
            const chartData = [...sortedMonths].reverse().map(m => ({ label: m.split(' ')[0].substring(0, 3), value: groups[m].total }));

            return (
                <div className="animate-fade-in pb-32">
                     <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => setView('clientDetail')} className="p-2 -ml-2 rounded-full hover:bg-gray-200"><Icons.ChevronRight size={24} className="rotate-180" /></button>
                        <h2 className="text-xl font-bold">Ordini: {selectedClient.ragioneSociale}</h2>
                    </div>

                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                        <div className="text-xs font-bold uppercase text-gray-400 mb-1">Totale Cliente</div>
                        <div className="text-3xl font-bold text-blue-600">€ {grandTotal.toFixed(2)}</div>
                    </div>

                    {chartData.length > 0 && <MonthChart data={chartData} />}

                    <div className="space-y-6">
                        {sortedMonths.length === 0 ? <div className="text-center py-10 text-gray-400">Nessun ordine.</div> : 
                        sortedMonths.map(month => (
                            <div key={month}>
                                <div className="flex justify-between items-end mb-2 px-1">
                                    <h3 className="font-bold text-gray-500 uppercase text-sm">{month}</h3>
                                    <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">€ {groups[month].total.toFixed(2)}</span>
                                </div>
                                <div className="space-y-3">
                                    {groups[month].items.map(o => (
                                        <div key={o.id} onClick={() => { setOrderForm(o); setView('createOrder'); }} className="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer active:scale-[0.99] transition-transform">
                                            <div className="flex justify-between font-bold text-gray-800">
                                                <span>{new Date(o.createdAt).toLocaleDateString('it-IT')}</span>
                                                <div className="text-right">
                                                    <div className="text-blue-600">€{parseFloat(o.amount).toFixed(2)}</div>
                                                    {o.commission > 0 && <div className="text-[10px] text-gray-400 font-normal">Provv. €{parseFloat(o.commission).toFixed(2)}</div>}
                                                </div>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">Ordine: {o.offerNumber}</div>
                                        </div>
                                    ))}
                                </div>
                                {/* Totale Mensile Footer */}
                                <div className="flex justify-end mt-2 mb-4 border-t border-gray-100 pt-2">
                                    <div className="text-sm font-bold text-gray-600">Totale {month}: <span className="text-blue-600">€ {groups[month].total.toFixed(2)}</span></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- APP MAIN COMPONENT ---
        const App = () => {
            const [db, setDb] = useState(null);
            const [userKey, setUserKey] = useState(localStorage.getItem('crm_user_key') || '');
            const [isLoggedIn, setIsLoggedIn] = useState(!!userKey);
            const [view, setView] = useState('dashboard');
            const [clients, setClients] = useState([]);
            const [reports, setReports] = useState([]);
            const [followups, setFollowups] = useState([]);
            const [ideas, setIdeas] = useState([]);
            const [orders, setOrders] = useState([]); 
            const [selectedReport, setSelectedReport] = useState(null);
            const [selectedClient, setSelectedClient] = useState(null);
            const [selectedFollowup, setSelectedFollowup] = useState(null); // NUOVO STATO
            const [selectedIdea, setSelectedIdea] = useState(null); // NUOVO STATO
            const [reportForm, setReportForm] = useState({});
            const [clientForm, setClientForm] = useState({});
            const [followupForm, setFollowupForm] = useState({});
            const [ideaForm, setIdeaForm] = useState({});
            const [orderForm, setOrderForm] = useState({}); 
            const [message, setMessage] = useState({ text: '', type: '' });
            const [showCleanModal, setShowCleanModal] = useState(false);
            const [duplicatesData, setDuplicatesData] = useState([]);
            const fileInputRef = useRef(null);

            const showMsg = (text) => { setMessage({text}); setTimeout(() => setMessage({text:''}), 3000); };
            useEffect(() => { const app = initializeApp(firebaseConfig); const auth = getAuth(app); const dbInst = getFirestore(app); setDb(dbInst); signInAnonymously(auth); }, []);
            useEffect(() => {
                if (!db || !userKey) return;
                const key = userKey.toLowerCase().replace(/\s/g, '');
                const subs = [ 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/reports`), s => setReports(s.docs.map(d => ({ ...d.data(), id: d.id })))), 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/clients`), s => setClients(s.docs.map(d => ({ ...d.data(), id: d.id })))), 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/followups`), s => setFollowups(s.docs.map(d => ({ ...d.data(), id: d.id })))), 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/ideas`), s => setIdeas(s.docs.map(d => ({ ...d.data(), id: d.id })))),
                    onSnapshot(collection(db, `artifacts/${appId}/users/${key}/orders`), s => setOrders(s.docs.map(d => ({ ...d.data(), id: d.id }))))
                ];
                return () => subs.forEach(unsub => unsub());
            }, [db, userKey]);

            const saveItem = async (coll, data) => { const key = userKey.toLowerCase().replace(/\s/g, ''); const id = data.id || String(Date.now()); await setDoc(doc(db, `artifacts/${appId}/users/${key}/${coll}`, id), { ...data, id, createdAt: data.createdAt || new Date().toISOString() }); showMsg('Salvato!'); };
            const deleteItem = async (coll, id) => { if (confirm("Eliminare?")) { const key = userKey.toLowerCase().replace(/\s/g, ''); await deleteDoc(doc(db, `artifacts/${appId}/users/${key}/${coll}`, id)); return true; } return false; };
            const toggleTaskCompletion = async (coll, id, current) => { const key = userKey.toLowerCase().replace(/\s/g, ''); await setDoc(doc(db, `artifacts/${appId}/users/${key}/${coll}`, id), { completed: !current }, { merge: true }); };

            const handleCleanDuplicates = () => {
                const groups = [];
                
                // Helper for grouping
                const findDupes = (data, collectionName, keyFn, labelFn) => {
                    const map = {};
                    data.forEach(item => {
                        const k = keyFn(item);
                        if (!k) return;
                        if (!map[k]) map[k] = [];
                        map[k].push({ ...item, _sourceCollection: collectionName, _displayLabel: labelFn(item) });
                    });
                    Object.values(map).forEach(g => {
                        if (g.length > 1) groups.push(g);
                    });
                };

                // 1. Clienti (Ragione Sociale)
                findDupes(clients, 'clients', c => normalizeForSearch(c.ragioneSociale), c => c.ragioneSociale);

                // 2. Report (Cliente + Data + Categoria)
                findDupes(reports, 'reports', r => `${r.client}|${r.date}|${r.category}`, r => `${new Date(r.date).toLocaleDateString()} - ${r.category}`);

                // 3. Ordini (Cliente + Numero o Importo)
                findDupes(orders, 'orders', o => `${o.client}|${o.offerNumber || o.amount}`, o => `Ordine ${o.offerNumber || ''} - €${o.amount}`);

                // 4. Offerte/Followup (Cliente + Numero)
                findDupes(followups, 'followups', f => `${f.client}|${f.offerNumber}`, f => `Offerta ${f.offerNumber}`);

                // 5. Idee (Cliente + Testo)
                findDupes(ideas, 'ideas', i => `${i.client}|${(i.text || '').substring(0, 20)}`, i => i.text);

                if (groups.length > 0) {
                    setDuplicatesData(groups);
                    setShowCleanModal(true);
                } else {
                    showMsg('Nessun duplicato trovato.');
                }
            };

            const executeClean = async (items) => {
                const key = userKey.toLowerCase().replace(/\s/g, '');
                await Promise.all(items.map(i => deleteDoc(doc(db, `artifacts/${appId}/users/${key}/${i.collection}`, i.id))));
                setShowCleanModal(false); showMsg('Pulizia completata!');
            };

            const exportToExcel = () => {
                if (!window.XLSX) { showMsg("Libreria Export non caricata"); return; }
                const wb = XLSX.utils.book_new();
                const addSheet = (name, data) => { if(data.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), name); };
                addSheet('Clienti', clients);
                addSheet('Report', reports);
                addSheet('Ordini', orders);
                addSheet('Offerte', followups);
                addSheet('Idee', ideas);
                XLSX.writeFile(wb, `CRM_Backup_${new Date().toISOString().slice(0,10)}.xlsx`);
                showMsg('Backup scaricato!');
            };

            const contextValue = { 
                db, userKey, view, setView, clients, reports, followups, ideas, orders,
                selectedReport, setSelectedReport, selectedClient, setSelectedClient, 
                selectedFollowup, setSelectedFollowup, selectedIdea, setSelectedIdea, // AGGIUNTI
                reportForm, setReportForm, clientForm, setClientForm, followupForm, setFollowupForm, ideaForm, setIdeaForm, orderForm, setOrderForm,
                // MODIFICA: save functions support _returnView
                saveReport: d => { saveItem('reports', d); setView(d._returnView || 'dashboard'); }, 
                saveClient: d => { saveItem('clients', d); setView('clients'); }, 
                saveFollowup: d => { saveItem('followups', d); setView(d._returnView || 'dashboard'); }, 
                saveIdea: d => { saveItem('ideas', d); setView(d._returnView || 'dashboard'); }, 
                saveOrder: d => { saveItem('orders', d); setView('ordersList'); },
                deleteItem, toggleTaskCompletion, handleLogout: () => { localStorage.removeItem('crm_user_key'); setUserKey(''); setIsLoggedIn(false); },
                fileInputRef, exportToExcel, handleCleanDuplicates, setFollowupForm, setIdeaForm, setReportForm // Added missing export
            };

            if (!isLoggedIn) return ( <div className="min-h-screen bg-gray-100 flex justify-center items-center p-4"><form onSubmit={(e) => { e.preventDefault(); const val = e.target.elements[0].value.trim(); if(val) { localStorage.setItem('crm_user_key', val); setUserKey(val); setIsLoggedIn(true); } }} className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center"><Icons.Lock className="mx-auto mb-4 text-blue-600" size={48}/><h1 className="text-2xl font-bold mb-4">WorkReport CRM</h1><input type="text" placeholder="Chiave Segreta" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center font-bold outline-none border focus:border-blue-500"/><button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Accedi</button></form></div> );

            return (
                <CRMContext.Provider value={contextValue}>
                    <div className="min-h-screen bg-gray-100 flex justify-center">
                        <div className="w-full max-w-7xl h-dvh overflow-hidden flex flex-col bg-white sm:shadow-2xl sm:rounded-3xl relative">
                            <div className="flex-1 overflow-y-auto p-6 scrollbar-hide">
                                {view === 'dashboard' && <DashboardView />}
                                {view === 'todo' && <TodoView />}
                                {view === 'stats' && <StatsView />}
                                {view === 'clients' && <ClientsList />}
                                {view === 'createClient' && <ClientForm />}
                                {view === 'clientDetail' && <ClientDetailView />}
                                {view === 'clientCompletedTodos' && <ClientCompletedTodosView />}
                                {view === 'create' && <ReportForm />}
                                {view === 'list' && <ReportList />}
                                {view === 'detail' && <ReportDetailView />}
                                {view === 'followupDetail' && <FollowupDetailView />} {/* NUOVA VISTA */}
                                {view === 'ideaDetail' && <IdeaDetailView />} {/* NUOVA VISTA */}
                                {view === 'createFollowup' && <FollowupForm />}
                                {view === 'createOrder' && <OrderForm />}
                                {view === 'createIdea' && <IdeaForm />}
                                {view === 'ordersList' && <OrdersListView />}
                                {view === 'clientOrders' && <ClientOrdersView />}
                                {view === 'clientReports' && <ClientReportsView />}
                                {view === 'followupsList' && <FollowupsListView />}
                                {view === 'ideasList' && <IdeasListView />}
                            </div>
                            <nav className="border-t p-3 bg-white flex justify-around">
                                {[{ id: 'dashboard', icon: Icons.LayoutDashboard, label: 'Home' }, { id: 'todo', icon: Icons.CheckSquare, label: 'TO-DO' }, { id: 'stats', icon: Icons.BarChart, label: 'Situazione' }, { id: 'clients', icon: Icons.Users, label: 'Clienti' }].map(item => (<button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center p-2 transition-colors ${view === item.id || (view.startsWith('client') && item.id === 'clients') ? 'text-blue-600' : 'text-gray-400'}`}><item.icon size={24} /><span className="text-[10px] font-bold">{item.label}</span></button>))}
                            </nav>
                            {message.text && (<div className="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-xl text-white font-bold text-sm z-50 bg-blue-500 animate-fade-in">{message.text}</div>)}
                            {showCleanModal && <CleanDuplicatesModal groups={duplicatesData} onClose={() => setShowCleanModal(false)} onDelete={executeClean} />}
                        </div>
                    </div>
                </CRMContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
